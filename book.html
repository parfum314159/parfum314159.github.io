<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<style>
body {
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
}
img {
  width: 250px;
  border-radius: 8px;
  margin-bottom: 10px;
}
button {
  padding: 10px 20px;
  background: #ff4500;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin: 10px;
}
button.share {
  background: #00aaff;
}
</style>
</head>
<body>

<div id="content">Loading book...</div>

<script>
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

if (!bookId) {
  document.getElementById("content").innerText = "Book not found";
}

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
async function loadBook() {
  try {
    const res = await fetch(`${BACKEND_URL}/book/${bookId}`);
    const data = await res.json();
    if (!data.success) throw new Error();

    const b = data.book;
    document.getElementById("content").innerHTML = `
      <img src="${b.cover}">
      <h2>${b.title}</h2>
      <p>${b.description || ""}</p>
      <p><strong>${b.price} Pi</strong></p>
      <p>By ${b.owner}</p>
      <button id="buyBtn">Buy with Pi ğŸª™</button>
      <button id="shareBtn" class="share">Share Link ğŸ”—</button>
    `;

    // Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©
    document.getElementById("buyBtn").onclick = async () => {
      if (!window.Pi) return alert("Open in Pi Browser to buy.");
      try {
        const payment = await Pi.createPayment({
          amount: b.price,
          memo: `Purchase book: ${b.title}`,
          metadata: { bookId: b.id }
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©
        const res = await fetch(`${BACKEND_URL}/completePayment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId: payment.id, bookId: b.id })
        });
        const result = await res.json();

        if(result.success) {
          alert("âœ… Payment successful! Opening book...");
          window.open(result.pdfUrl, "_blank");
        } else {
          alert("âŒ Payment failed. Please try again.");
        }
      } catch (e) {
        alert("âŒ Payment failed or canceled.");
        console.error(e);
      }
    };

    // Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø·
    document.getElementById("shareBtn").onclick = () => {
      const bookUrl = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: b.title,
          url: bookUrl
        }).catch(console.error);
      } else {
        navigator.clipboard.writeText(bookUrl)
          .then(() => alert("âœ… Link copied to clipboard"))
          .catch(() => alert("âš ï¸ Copy manually: " + bookUrl));
      }
    };

  } catch(e) {
    console.error(e);
    document.getElementById("content").innerText = "Error loading book";
  }
}

loadBook();
</script>

</body>
</html>
