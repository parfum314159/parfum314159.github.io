<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>

<!-- ğŸ”´ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
<meta property="og:title" content="Spicy Library Book">
<meta property="og:description" content="Discover this book on Spicy Library">
<meta property="og:image" content="">
<meta property="og:type" content="website">

<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;padding:20px;}
img{width:250px;border-radius:8px;}
button{padding:10px 20px;background:#ff4500;color:#fff;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>

<body>

<div id="content">Loading book...</div>

<script>
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

// 1ï¸âƒ£ Ù†Ø£Ø®Ø° id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

if (!bookId) {
  document.getElementById("content").innerText = "Book not found";
}

// 2ï¸âƒ£ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨
fetch(`${BACKEND_URL}/book/${bookId}`)
  .then(res => res.json())
  .then(data => {
    if (!data.success) throw new Error();

    const b = data.book;

    // ğŸ”´ ØªØ­Ø¯ÙŠØ« meta tags (Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©)
    document.querySelector("meta[property='og:title']").content = b.title;
    document.querySelector("meta[property='og:description']").content = b.description || "Book on Spicy Library";
    document.querySelector("meta[property='og:image']").content = b.cover;

    document.getElementById("content").innerHTML = `
  <img src="${b.cover}">
  <h2>${b.title}</h2>
  <p>${b.description || ""}</p>
  <p><strong>${b.price} Pi</strong></p>
  <p>By ${b.owner}</p>

  <button onclick="buyBook('${b.id}', ${b.price})">
    Buy with Pi ğŸª™
  </button>

  <br><br>

  <button onclick="share()">Share ğŸ”—</button>
`;

  })
  .catch(() => {
    document.getElementById("content").innerText = "Error loading book";
  });

function share() {
  const url = window.location.href;

  if (navigator.share) {
    navigator.share({
      title: "Spicy Library Book",
      url: url
    });
  } else {
    prompt("Copy this link:", url);
  }
}


async function buyBook(bookId, price) {
  if (!window.Pi) {
    alert("Please open this page in Pi Browser");
    return;
  }

  try {
    // 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹
    const payment = await Pi.createPayment({
      amount: price,
      memo: `Buy book ${bookId}`,
      metadata: { bookId }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId })
        });
      },

      onReadyForServerCompletion: async (paymentId) => {
        await fetch(`${BACKEND_URL}/complete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId })
        });

        alert("âœ… Purchase successful!");
      },

      onCancel: () => {
        alert("âŒ Payment cancelled");
      },

      onError: (err) => {
        console.error(err);
        alert("âŒ Payment failed");
      }
    });

  } catch (e) {
    console.error(e);
    alert("âŒ Error during payment");
  }
}


  
</script>

</body>
</html>
