<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;padding:20px;}
img{width:250px;border-radius:8px;}
button{padding:10px 20px;background:#ff4500;color:#fff;border:none;border-radius:6px;cursor:pointer;margin:10px;}
</style>
</head>
<body>

<div id="content">Loading book...</div>

<script>
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";
const ALLOWED_ORIGIN = "https://parfum314159.github.io"; // Ù…ÙˆÙ‚Ø¹Ùƒ

const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

if (!bookId) {
  document.getElementById("content").innerText = "Book not found";
}

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
async function loadBook() {
  try {
    const res = await fetch(`${BACKEND_URL}/book/${bookId}`);
    const data = await res.json();
    if (!data.success) throw new Error();

    const b = data.book;
    document.getElementById("content").innerHTML = `
      <img src="${b.cover}">
      <h2>${b.title}</h2>
      <p>${b.description || ""}</p>
      <p><strong>${b.price} Pi</strong></p>
      <p>By ${b.owner}</p>
      <button id="buyBtn">Buy with Pi ğŸª™</button>
    `;

    document.getElementById("buyBtn").onclick = () => {
      // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹ Ù„Ù€ index.html
      if (window.opener) {
        window.opener.postMessage({
          type: "BUY_BOOK",
          bookId: b.id,
          price: b.price
        }, ALLOWED_ORIGIN);
      } else {
        alert("Open this book from main site to buy.");
      }
    };

  } catch(e) {
    document.getElementById("content").innerText = "Error loading book";
  }
}

loadBook();

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
window.addEventListener("message", (event) => {
  if (event.origin !== ALLOWED_ORIGIN) return; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±
  const msg = event.data;

  if(msg.type === "PAYMENT_SUCCESS" && msg.bookId === bookId) {
    alert("âœ… Payment successful! Opening book...");
    window.open(msg.pdfUrl, "_blank");
  } else if(msg.type === "PAYMENT_FAILED") {
    alert("âŒ Payment failed. Please try again.");
  }
});
</script>

</body>
</html>
