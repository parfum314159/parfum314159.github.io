<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>

<!-- ‚úÖ Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- üî¥ Meta ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© -->
<meta property="og:title" content="Spicy Library Book">
<meta property="og:description" content="Discover this book on Spicy Library">
<meta property="og:image" content="">
<meta property="og:type" content="website">

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  padding:20px;
}
img{
  width:250px;
  border-radius:8px;
}
button{
  padding:10px 20px;
  background:#ff4500;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin:10px;
}
</style>
</head>

<body>

<div id="content">Loading book...</div>

<script>
// ================= CONFIG =================
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

// ================= PI SDK =================
Pi.init({ version: "2.0", sandbox: false });

// ================= USER UID =================
const params = new URLSearchParams(window.location.search);
let userUid = params.get("uid") || localStorage.getItem("userUid");

async function ensureLogin() {
  if (!userUid) {
    if (!window.Pi) {
      alert("Please open this page in Pi Browser");
      return false;
    }

    try {
      const user = await Pi.getUser();
      userUid = user.uid;
      localStorage.setItem("userUid", userUid);
      console.log("Logged in as", userUid);
      return true;
    } catch (e) {
      console.error(e);
      alert("‚ùå You must log in via Pi Network to continue");
      return false;
    }
  }
  return true;
}

// ================= GET BOOK ID =================
const bookId = params.get("id");
if (!bookId) {
  document.getElementById("content").innerText = "Book not found";
}

// ================= LOAD BOOK =================
async function loadBook() {
  try {
    const res = await fetch(`${BACKEND_URL}/book/${bookId}`);
    const data = await res.json();
    if (!data.success) throw new Error("Book not found");

    const b = data.book;

    // ÿ™ÿ≠ÿØŸäÿ´ meta tags
    document.querySelector("meta[property='og:title']").content = b.title;
    document.querySelector("meta[property='og:description']").content = b.description || "Book on Spicy Library";
    document.querySelector("meta[property='og:image']").content = b.cover;

    document.getElementById("content").innerHTML = `
      <img src="${b.cover}">
      <h2>${b.title}</h2>
      <p>${b.description || ""}</p>
      <p><strong>${b.price} Pi</strong></p>
      <p>By ${b.owner}</p>

      <button id="buyBtn">Buy with Pi ü™ô</button>
      <br>
      <button onclick="share()">Share üîó</button>
    `;

    document.getElementById("buyBtn").onclick = () => buyBook(b.id, b.price);

  } catch (e) {
    console.error(e);
    document.getElementById("content").innerText = "Error loading book";
  }
}

loadBook();

// ================= SHARE =================
function share() {
  const url = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Spicy Library Book", url });
  } else {
    prompt("Copy this link:", url);
  }
}

// ================= BUY BOOK =================
async function buyBook(bookId, price) {
  if (!await ensureLogin()) return;

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Spicy Library - Book Purchase",
      metadata: { bookId, userUid }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, bookId, userUid })
        });
      },

      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(`${BACKEND_URL}/complete-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, txid, bookId, userUid })
        });

        if (!res.ok) {
          const err = await res.json();
          alert("Payment failed: " + (err.error || ""));
          return;
        }

        const data = await res.json();
        alert("‚úÖ Purchase successful!");
        window.open(data.pdfUrl, "_blank");
      },

      onCancel: () => alert("‚ùå Payment cancelled"),
      onError: (err) => {
        console.error(err);
        alert("‚ùå Payment error");
      }
    });
  } catch (e) {
    console.error(e);
    alert("Error during payment. Use Pi Browser.");
  }
}

</script>

</body>
</html>
