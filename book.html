<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>

<!-- âœ… Pi SDK (Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ù‹Ø§) -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- ğŸ”´ Meta Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
<meta property="og:title" content="Spicy Library Book">
<meta property="og:description" content="Discover this book on Spicy Library">
<meta property="og:image" content="">
<meta property="og:type" content="website">

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  padding:20px;
}
img{
  width:250px;
  border-radius:8px;
}
button{
  padding:10px 20px;
  background:#ff4500;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin:10px;
}
</style>
</head>

<body>

<div id="content">Loading book...</div>

<script>
// ================= CONFIG =================
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

// âœ… ØªÙ‡ÙŠØ¦Ø© Pi SDK
Pi.init({ version: "2.0", sandbox: false });

// ================= LOGIN CHECK =================
let userUid = localStorage.getItem("userUid");

async function ensureLogin() {
  if (!userUid) {
    if (!window.Pi) {
      alert("Please open this page in Pi Browser");
      return false;
    }

    try {
      const user = await Pi.getUser(); // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      userUid = user.uid;
      localStorage.setItem("userUid", userUid);
      console.log("Logged in as", userUid);
      return true;
    } catch (e) {
      console.error(e);
      alert("âŒ You must log in via Pi Network to continue");
      return false;
    }
  }
  return true;
}

// ================= GET BOOK ID =================
const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

if (!bookId) {
  document.getElementById("content").innerText = "Book not found";
}

// ================= LOAD BOOK =================
fetch(`${BACKEND_URL}/book/${bookId}`)
  .then(res => res.json())
  .then(data => {
    if (!data.success) throw new Error();

    const b = data.book;

    // ØªØ­Ø¯ÙŠØ« meta tags
    document.querySelector("meta[property='og:title']").content = b.title;
    document.querySelector("meta[property='og:description']").content =
      b.description || "Book on Spicy Library";
    document.querySelector("meta[property='og:image']").content = b.cover;

    document.getElementById("content").innerHTML = `
      <img src="${b.cover}">
      <h2>${b.title}</h2>
      <p>${b.description || ""}</p>
      <p><strong>${b.price} Pi</strong></p>
      <p>By ${b.owner}</p>

      <button onclick="buyBook('${b.id}', ${b.price})">
        Buy with Pi ğŸª™
      </button>

      <br>

      <button onclick="share()">Share ğŸ”—</button>
    `;
  })
  .catch(() => {
    document.getElementById("content").innerText = "Error loading book";
  });

// ================= SHARE =================
function share() {
  const url = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Spicy Library Book", url });
  } else {
    prompt("Copy this link:", url);
  }
}

// ================= BUY BOOK =================
async function buyBook(bookId, price) {
  // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡
  if (!await ensureLogin()) return;

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Spicy Library - Book Purchase",
      metadata: { bookId, userUid } // Ø±Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }, {
      // ğŸ”¹ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, bookId, userUid })
        });
      },

      // ğŸ”¹ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(`${BACKEND_URL}/complete-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, txid, bookId, userUid })
        });

        if (!res.ok) {
          alert("Payment failed");
          return;
        }

        const data = await res.json();
        alert("âœ… Purchase successful!");
        window.open(data.pdfUrl, "_blank");
      },

      onCancel: () => alert("âŒ Payment cancelled"),
      onError: (err) => {
        console.error(err);
        alert("âŒ Payment error");
      }
    });
  } catch (e) {
    console.error(e);
    alert("âŒ Error during payment");
  }
}

</script>

</body>
</html>
