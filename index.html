<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“š Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  padding:20px;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  background:#ff4500;
  color:#fff;
  cursor:pointer;
  margin:5px;
}
.hidden{display:none}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center
}
.book{
  background:#1c1c1c;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px
}
.book img{width:200px}
.notice{color:#ccc;font-size:14px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>ðŸ“š Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="logout()">Logout</button>
  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

/* ================= PI INIT ================= */
if (!window.Pi) {
  alert("âŒ Open this app inside Pi Browser");
}

Pi.init({
  version: "2.0",
  sandbox: false
});

let user = null;

/* ================= LOGIN ================= */
loginBtn.onclick = async () => {
  try {
    const auth = await Pi.authenticate(["username","payments"]);
    user = auth.user;

    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + user.username;

    loadBooks();
  } catch (e) {
    alert("Login failed â€“ use Pi Browser");
  }
};

function logout(){
  location.reload();
}

/* ================= LOAD BOOKS ================= */
async function loadBooks(){
  books.innerHTML = "";
  const snap = await db.collection("books").get();

  snap.forEach(doc=>{
    const b = doc.data();
    books.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${doc.id}', ${b.price})">
          Buy with Pi
        </button>
      </div>`;
  });
}

/* ================= BUY (CORRECT WAY) ================= */
window.buy = async (bookId, price) => {

  if (!window.Pi) {
    alert("âŒ Pi Browser required");
    return;
  }

  try {
    const payment = await Pi.createPayment({
      amount: price,
      currency: "Pi",
      memo: "Buy book",
      metadata: { bookId }
    });

    payment.onReadyForServerApproval(async (paymentId) => {

      await fetch("https://pi-backend-c8nz.onrender.com/approve-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId })
      });

      await fetch("https://pi-backend-c8nz.onrender.com/complete-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId })
      });

      const doc = await db.collection("books").doc(bookId).get();
      window.open(doc.data().pdf, "_blank");
    });

    payment.onCancel(() => alert("Payment cancelled"));
    payment.onError(err => {
      console.error(err);
      alert("Payment error");
    });

  } catch (err) {
    console.error(err);
    alert("Payment failed");
  }
};
</script>

</body>
</html>
