<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;max-width:400px;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
.book h4{margin:10px 0 5px;}
.description{font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
.owner{font-size:12px;color:#ff4500;}
.language{font-size:12px;color:#aaa;}
.pages{font-size:12px;color:#0f9;font-weight:bold;}
.sales{font-size:12px;color:#ffd700;font-weight:bold;}
.ratings{font-size:14px;margin:8px 0;}
.like-btn, .dislike-btn{background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
.like-btn.liked, .dislike-btn.disliked{opacity:0.6;}
.notice{font-size:14px;color:#ccc;}
.tab-btn{background:#333;margin:10px;padding:10px 20px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
.tab-btn.active{background:#ff4500;}
.tab-content{display:none;}
.tab-content.active{display:block;}
#searchInput{width:80%;max-width:500px;margin:15px auto;display:block;padding:10px;}
.disclaimer{font-size:12px;color:#ccc;margin:20px;padding:10px;border-top:1px solid #333;}
.upload-status{font-size:14px;color:#0f9;margin:10px 0;}
.sales-book{background:#222;border:1px solid #444;border-radius:8px;padding:15px;margin:20px auto;width:90%;max-width:500px;}
.profit{font-size:16px;color:#0f9;font-weight:bold;}
.total-profit{font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
#payoutBtn{background:#00aaff;font-size:16px;padding:15px 30px;margin-top:20px;}
.payout-note{font-size:14px;color:#aaa;margin:15px 0;padding:10px;background:#222;border-radius:8px;}
</style>
</head>
<body>

<div id="login">
  <h1>ğŸ“š Spicy Library</h1>
  <p class="notice">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pi Network (Ø§ÙØªØ­ ÙÙŠ Pi Browser)</p>
  <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

  <div>
    <button class="tab-btn active" onclick="openTab('store')">Ø§Ù„Ù…ØªØ¬Ø±</button>
    <button class="tab-btn" onclick="openTab('purchases')">Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</button>
    <button class="tab-btn" onclick="openTab('sales')">Ù…Ø¨ÙŠØ¹Ø§ØªÙŠ</button>
  </div>

  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <h3>Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</h3>
      <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
      <input id="price" type="number" min="0.1" step="0.1" placeholder="Ø§Ù„Ø³Ø¹Ø± (Pi)">
      <textarea id="description" placeholder="ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3"></textarea>
      <select id="language">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©</option>
        <option value="English">English</option>
        <option value="Arabic">Arabic</option>
        <option value="French">French</option>
        <option value="Spanish">Spanish</option>
        <option value="German">German</option>
        <option value="Other">Other</option>
      </select>
      <p>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
      <input id="manualPages" type="number" placeholder="Ù…Ø«Ø§Ù„: 250" min="1">
      <p>ğŸ“· ØºÙ„Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨ (ØµÙˆØ± ÙÙ‚Ø·)</p>
      <button id="uploadCoverBtn">Ø±ÙØ¹ Ø§Ù„ØºÙ„Ø§Ù</button>
      <p id="coverStatus" class="upload-status"></p>
      <p>ğŸ“„ Ù…Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨ (PDF ÙÙ‚Ø·)</p>
      <button id="uploadPdfBtn">Ø±ÙØ¹ PDF</button>
      <p id="pdfStatus" class="upload-status"></p>
      <br><br>
      <label class="notice">
        <input type="checkbox" id="rights">
        Ø£Ø¤ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ø£Ù…Ù„Ùƒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨
      </label><br><br>
      <button id="saveBookBtn" disabled>Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨</button>
    </div>

    <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨</h3>
    <input type="text" id="searchInput" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨..." oninput="searchBooks()">
    <div class="books" id="books"></div>

    <div class="disclaimer">
      ØªÙ†ÙˆÙŠÙ‡: Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø­Ù‚ÙˆÙ‚ Ù†Ø´Ø±. ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¹Ù† Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ ÙŠØ±ÙØ¹Ù‡Ø§.
    </div>
  </div>

  <div id="purchases" class="tab-content">
    <h3>ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</h3>
    <div class="books" id="myBooks"></div>
  </div>

  <div id="sales" class="tab-content">
    <h3>Ù…Ø¨ÙŠØ¹Ø§ØªÙŠ ÙˆØ±Ø¨Ø­ÙŠ</h3>
    <p>Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©: 30% â€“ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ 70% Ù…Ù† ÙƒÙ„ Ø¨ÙŠØ¹</p>
    <p>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 5 Pi</p>
    <div class="payout-note">
      <strong>ÙˆÙ‚Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø­Ø¨:</strong> ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙˆÙ‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù…Ù† 1-2 Ø£ÙŠØ§Ù… Ø¥Ù„Ù‰ 30 ÙŠÙˆÙ…Ù‹Ø§ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù….
    </div>
    <div id="mySalesBooks"></div>
    <div id="totalEarnings" class="total-profit">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button id="payoutBtn" onclick="requestPayout()" disabled>Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
  </div>
</div>

<script>
// ================= PI SDK =================
Pi.init({ version: "2.0", sandbox: false });

let user = null;
let userUid = null;
let coverUrl = "";
let pdfUrl = "";
let pageCount = "Unknown";

const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

// ================= CLOUDINARY =================
const coverWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "covers",
  resourceType: "image",
  clientAllowedFormats: ["jpg", "jpeg", "png", "webp"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    coverUrl = result.info.secure_url;
    document.getElementById("coverStatus").innerText = "ØªÙ… Ø±ÙØ¹ Ø§Ù„ØºÙ„Ø§Ù Ø¨Ù†Ø¬Ø§Ø­!";
    checkSaveReady();
  }
});

const pdfWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "pdfs",
  resourceType: "raw",
  clientAllowedFormats: ["pdf"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    pdfUrl = result.info.secure_url;
    pageCount = result.info.pages || "Unknown";
    document.getElementById("pdfStatus").innerText = "ØªÙ… Ø±ÙØ¹ PDF Ø¨Ù†Ø¬Ø§Ø­!" + (result.info.pages ? ` (Ø§Ù„ØµÙØ­Ø§Øª: ${result.info.pages})` : "");
    checkSaveReady();
  }
});

document.getElementById("uploadCoverBtn").onclick = () => coverWidget.open();
document.getElementById("uploadPdfBtn").onclick = () => pdfWidget.open();

function checkSaveReady() {
  document.getElementById("saveBookBtn").disabled = !(coverUrl && pdfUrl && user);
}

// ================= ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø§Ù„Ù‚ =================
function onIncompletePaymentFound(payment) {
  console.log("ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¯ÙØ¹Ø© Ø¹Ø§Ù„Ù‚Ø©:", payment);
  return true; // ÙŠØªØ¬Ø§Ù‡Ù„ ØªÙ…Ø§Ù…Ù‹Ø§ ÙˆÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡
}

// ================= ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =================
document.getElementById("loginBtn").onclick = async () => {
  try {
    const authResult = await Pi.authenticate(["username", "payments"], onIncompletePaymentFound);
    user = authResult.user;
    userUid = user.uid;

    document.getElementById("welcome").innerText = `Ù…Ø±Ø­Ø¨Ø§ØŒ ${user.username}!`;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

    loadBooks();
    loadMyPurchases();
    loadMySales();
  } catch (err) {
    alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Pi Browser.");
  }
};

function logout() {
  location.reload();
}

// ================= Ø±ÙØ¹ ÙƒØªØ§Ø¨ =================
async function saveBook() {
  if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  if (!document.getElementById("rights").checked) return alert("Ø£ÙƒØ¯ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø±");

  const title = document.getElementById("title").value.trim();
  const price = Number(document.getElementById("price").value);
  const description = document.getElementById("description").value.trim();
  const language = document.getElementById("language").value;
  const manualPages = document.getElementById("manualPages").value.trim();

  if (!title || price <= 0 || !coverUrl || !pdfUrl) return alert("Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

  const finalPages = manualPages || pageCount;

  const btn = document.getElementById("saveBookBtn");
  btn.disabled = true;
  btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

  try {
    const res = await fetch(`${BACKEND_URL}/save-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title, price, description, language, pageCount: finalPages,
        cover: coverUrl, pdf: pdfUrl, owner: user.username, ownerUid: userUid
      })
    });

    if (!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");

    alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
    toggleAdd();
    coverUrl = pdfUrl = "";
    document.getElementById("coverStatus").innerText = "";
    document.getElementById("pdfStatus").innerText = "";
    checkSaveReady();
    loadBooks();
    loadMySales();
  } catch (e) {
    alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + e.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨";
  }
}

// ================= ØªÙ‚ÙŠÙŠÙ… ÙƒØªØ§Ø¨ =================
async function rateBook(bookId, voteType, button) {
  if (!userUid) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  try {
    await fetch(`${BACKEND_URL}/rate-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, voteType, userUid })
    });

    button.disabled = true;
    button.classList.add(voteType === 'like' ? 'liked' : 'disliked');
    const sibling = button.parentNode.querySelector(voteType === 'like' ? '.dislike-btn' : '.like-btn');
    if (sibling) sibling.disabled = true;
    loadBooks();
    loadMyPurchases();
  } catch (e) {
    alert("ÙØ´Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
  }
}

// ================= Ø´Ø±Ø§Ø¡ ÙƒØªØ§Ø¨ =================
async function buy(bookId, price) {
  if (!userUid) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù€ ${price} PiØŸ`)) return;

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Ø´Ø±Ø§Ø¡ ÙƒØªØ§Ø¨ Ù…Ù† Spicy Library",
      metadata: { bookId, userUid }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(`${BACKEND_URL}/complete-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId, txid, bookId, userUid })
        });

        if (!res.ok) {
          alert("ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹");
          return;
        }

        const data = await res.json();
        window.open(data.pdfUrl, "_blank");
        alert("ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ÙƒØªØ§Ø¨ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù† ğŸ“š");
        loadBooks();
        loadMyPurchases();
        loadMySales();
      },
      onCancel: () => alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"),
      onError: (err) => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " + err.message)
    });
  } catch (e) {
    alert("Ø§Ø³ØªØ®Ø¯Ù… Pi Browser Ù„Ù„Ø¯ÙØ¹");
  }
}

// ================= ØªØ­Ù…ÙŠÙ„ PDF =================
async function downloadPdf(bookId) {
  try {
    const res = await fetch(`${BACKEND_URL}/get-pdf`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, userUid })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    window.open(data.pdfUrl, "_blank");
  } catch (e) {
    alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
  }
}

// ================= Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ =================
async function loadBooks() {
  const box = document.getElementById("books");
  box.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</p>";
  try {
    const res = await fetch(`${BACKEND_URL}/books`);
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    box.innerHTML = "";
    if (books.length === 0) return box.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…ØªØ§Ø­Ø©.</p>";

    for (const b of books) {
      // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
      const ratingsRes = await fetch(`${BACKEND_URL}/book-ratings`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookId: b.id, userUid })
      });
      const ratingsJson = await ratingsRes.json();
      const { likes = 0, dislikes = 0, userVote = null } = ratingsJson.success ? ratingsJson : {};

      const desc = b.description ? b.description.substring(0, 100) + "..." : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
      const lang = b.language ? `Ø§Ù„Ù„ØºØ©: ${b.language}` : "";
      const owner = `Ø¨ÙˆØ§Ø³Ø·Ø©: ${b.owner}`;
      const pages = b.pageCount !== "Unknown" ? `Ø§Ù„ØµÙØ­Ø§Øª: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${b.salesCount}` : "";

      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}" alt="ØºÙ„Ø§Ù">
          <h4>${b.title}</h4>
          <p><strong>${b.price} Pi</strong></p>
          <div class="description">${desc}</div>
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          <div class="ratings">
            <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${b.id}', 'like', this)" ${userVote || !user ? 'disabled' : ''}>ğŸ‘</button> ${likes}
            <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${b.id}', 'dislike', this)" ${userVote || !user ? 'disabled' : ''}>ğŸ‘</button> ${dislikes}
          </div>
          <button onclick="buy('${b.id}', ${b.price})" ${!user ? 'disabled' : ''}>Ø´Ø±Ø§Ø¡ Ø¨Ù€ Pi</button>
        </div>`;
    }
  } catch (e) {
    box.innerHTML = "<p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...</p>";
    setTimeout(loadBooks, 5000);
  }
}

// ================= Ø¬Ù„Ø¨ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ =================
async function loadMyPurchases() {
  const box = document.getElementById("myBooks");
  box.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...</p>";
  if (!userUid) return box.innerHTML = "<p>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† ÙØ¶Ù„Ùƒ.</p>";

  try {
    const res = await fetch(`${BACKEND_URL}/my-purchases`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userUid })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    box.innerHTML = "";
    if (books.length === 0) return box.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¹Ø¯.</p>";

    for (const b of books) {
      const ratingsRes = await fetch(`${BACKEND_URL}/book-ratings`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookId: b.id, userUid })
      });
      const ratingsJson = await ratingsRes.json();
      const { likes = 0, dislikes = 0, userVote = null } = ratingsJson.success ? ratingsJson : {};

      const desc = b.description ? b.description.substring(0, 100) + "..." : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
      const lang = b.language ? `Ø§Ù„Ù„ØºØ©: ${b.language}` : "";
      const owner = `Ø¨ÙˆØ§Ø³Ø·Ø©: ${b.owner}`;
      const pages = b.pageCount !== "Unknown" ? `Ø§Ù„ØµÙØ­Ø§Øª: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${b.salesCount}` : "";

      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}" alt="ØºÙ„Ø§Ù">
          <h4>${b.title}</h4>
          <div class="description">${desc}</div>
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          <div class="ratings">
            <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${b.id}', 'like', this)" ${userVote ? 'disabled' : ''}>ğŸ‘</button> ${likes}
            <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${b.id}', 'dislike', this)" ${userVote ? 'disabled' : ''}>ğŸ‘</button> ${dislikes}
          </div>
          <button onclick="downloadPdf('${b.id}')">ØªØ­Ù…ÙŠÙ„ PDF</button>
        </div>`;
    }
  } catch (e) {
    box.innerHTML = "<p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...</p>";
    setTimeout(loadMyPurchases, 5000);
  }
}

// ================= Ø¬Ù„Ø¨ Ù…Ø¨ÙŠØ¹Ø§ØªÙŠ =================
async function loadMySales() {
  const box = document.getElementById("mySalesBooks");
  const totalBox = document.getElementById("totalEarnings");
  box.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...</p>";
  totalBox.innerHTML = "";
  if (!user) return box.innerHTML = "<p>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† ÙØ¶Ù„Ùƒ.</p>";

  try {
    const res = await fetch(`${BACKEND_URL}/my-sales`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user.username })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    if (books.length === 0) {
      box.innerHTML = "<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ø£ÙŠ ÙƒØªØ¨ Ø¨Ø¹Ø¯.</p>";
      totalBox.innerHTML = "<div class='total-profit'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Pi</div>";
      document.getElementById("payoutBtn").disabled = true;
      return;
    }

    let total = 0;
    box.innerHTML = "";
    for (const b of books) {
      const profit = (b.salesCount || 0) * b.price * 0.7;
      total += profit;
      box.innerHTML += `
        <div class="sales-book">
          <img src="${b.cover}" style="width:150px;border-radius:6px;">
          <h4>${b.title}</h4>
          <p>Ø§Ù„Ø³Ø¹Ø±: ${b.price} Pi</p>
          <p>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${b.salesCount || 0}</p>
          <div class="profit">Ø±Ø¨Ø­Ùƒ: ${profit.toFixed(2)} Pi (70%)</div>
        </div>`;
    }
    totalBox.innerHTML = `<div class='total-profit'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Pi</div>`;
    document.getElementById("payoutBtn").disabled = total < 5;
  } catch (e) {
    box.innerHTML = "<p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.</p>";
  }
}

// ================= Ø·Ù„Ø¨ Ø³Ø­Ø¨ =================
async function requestPayout() {
  const totalText = document.getElementById("totalEarnings").innerText;
  const totalEarnings = parseFloat(totalText.replace("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ", "").replace(" Pi", "")) || 0;

  if (totalEarnings < 5) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 5 Pi");

  const wallet = prompt(`Ø±Ø¨Ø­Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${totalEarnings.toFixed(2)} Pi\nØ£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi:`);
  if (!wallet || wallet.trim() === "") return alert("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù…Ø·Ù„ÙˆØ¨");

  const btn = document.getElementById("payoutBtn");
  btn.disabled = true;

  try {
    await fetch(`${BACKEND_URL}/reset-sales`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user.username })
    });

    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø±Ø¨Ø­.");
    loadMySales();
  } catch (e) {
    alert("ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨");
  } finally {
    btn.disabled = false;
  }
}

// ================= ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ =================
function openTab(tabName) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add("active");
  if (tabName === "store") loadBooks();
  if (tabName === "purchases") loadMyPurchases();
  if (tabName === "sales") loadMySales();
}

function searchBooks() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const books = document.querySelectorAll("#books .book");
  books.forEach(book => {
    const title = book.querySelector("h4").textContent.toLowerCase();
    book.style.display = title.includes(input) ? "block" : "none";
  });
}

function toggleAdd() {
  if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  document.getElementById("addBook").classList.toggle("hidden");
}
</script>
</body>
</html>
