<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“– Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  padding:20px;
}
button{
  background:#ff4500;
  color:white;
  border:none;
  padding:10px 20px;
  margin:5px;
  border-radius:6px;
  cursor:pointer;
}
.hidden{display:none;}
input,textarea{width:90%;padding:8px;margin:5px;}
.books{display:flex;flex-wrap:wrap;justify-content:center;}
.book{
  background:#1c1c1c;
  border:1px solid #333;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px;
}
.book img{width:200px;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>ðŸ“– Spicy Library</h1>
  <button onclick="login()">Login with Pi</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2 id="welcome"></h2>
  <button onclick="toggleAdd()">âž• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div id="add" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <input type="file" id="cover" accept="image/*">
    <input type="file" id="pdf" accept="application/pdf">
    <textarea id="desc" placeholder="Description"></textarea>
    <label>
      <input type="checkbox" id="rights">
      I own the rights of this book
    </label><br>
    <button onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
// ================= Firebase =================
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

// ================= Pi =================
Pi.init({version:"2.0", sandbox:true});
let user = null;

// ================= Cloudinary =================
const CLOUD_NAME = "dkb0phegf";
const UPLOAD_PRESET = "spicy1998";

async function uploadToCloudinary(file, folder){
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", UPLOAD_PRESET);
  form.append("folder", folder);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
    { method:"POST", body: form }
  );

  const data = await res.json();
  return data.secure_url;
}

// ================= Login =================
async function login(){
  try{
    const auth = await Pi.authenticate(["username","payments"]);
    user = auth.user;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("welcome").innerText = "Welcome " + user.username;
    loadBooks();
  }catch(e){
    alert("Login failed");
  }
}

function logout(){ location.reload(); }

// ================= Books =================
function toggleAdd(){
  document.getElementById("add").classList.toggle("hidden");
}

async function uploadBook(){
  if(!document.getElementById("rights").checked){
    alert("Confirm rights");
    return;
  }

  const titleVal = document.getElementById("title").value;
  const priceVal = Number(document.getElementById("price").value);
  const descVal = document.getElementById("desc").value;
  const coverFile = document.getElementById("cover").files[0];
  const pdfFile = document.getElementById("pdf").files[0];

  if(!titleVal || !priceVal || !coverFile || !pdfFile){
    alert("Fill all fields");
    return;
  }

  alert("Uploading... please wait");

  const coverURL = await uploadToCloudinary(coverFile,"covers");
  const pdfURL = await uploadToCloudinary(pdfFile,"pdfs");

  await db.collection("books").add({
    title: titleVal,
    price: priceVal,
    desc: descVal,
    cover: coverURL,
    pdf: pdfURL,
    owner: user.username,
    created: Date.now()
  });

  alert("Book uploaded");
  toggleAdd();
  loadBooks();
}

async function loadBooks(){
  const box = document.getElementById("books");
  box.innerHTML="";
  const snap = await db.collection("books").orderBy("created","desc").get();
  snap.forEach(doc=>{
    const b = doc.data();
    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${b.title}',${b.price})">Buy</button>
      </div>`;
  });
}

// ================= Payment (FIXED) =================
async function buy(title, price){
  try{
    await Pi.createPayment(
      {
        amount: price,
        memo: "Buy " + title,
        metadata: { book: title }
      },
      {
        onReadyForServerApproval: function(id){
          console.log("Approved:", id);
        },
        onReadyForServerCompletion: function(id, txid){
          alert("Payment successful!");
          console.log("TXID:", txid);
        },
        onCancel: function(){
          alert("Payment cancelled");
        },
        onError: function(err){
          alert("Payment error");
          console.error(err);
        }
      }
    );
  }catch(e){
    alert("Payment failed");
    console.error(e);
  }
}
</script>

</body>
</html>
