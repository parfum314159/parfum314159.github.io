<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìö Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;margin:10px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
.book h4{margin:10px 0 5px;}
.book p{margin:5px 0;}
.description{font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
.owner{font-size:12px;color:#ff4500;}
.language{font-size:12px;color:#aaa;}
.pages{font-size:12px;color:#0f9;font-weight:bold;}
.sales{font-size:12px;color:#ffd700;font-weight:bold;}
.ratings{font-size:14px;margin:8px 0;}
.like-btn, .dislike-btn{background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
.like-btn.liked, .dislike-btn.disliked{opacity:0.6;}
.notice{font-size:14px;color:#ccc;}
.tab-btn{background:#333;margin:10px;padding:10px 20px;}
.tab-btn.active{background:#ff4500;}
.tab-content{display:none;}
.tab-content.active{display:block;}
#searchInput{width:80%;margin:10px auto;display:block;}
.disclaimer{font-size:12px;color:#ccc;margin-top:20px;padding:10px;border-top:1px solid #333;}
.upload-status{font-size:14px;color:#0f0;margin:10px 0;}
.sales-book{background:#222;border:1px solid #444;border-radius:8px;padding:15px;margin:20px auto;width:90%;max-width:500px;}
.sales-book h4{margin:10px 0;}
.profit{font-size:16px;color:#0f9;font-weight:bold;}
.total-profit{font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
#payoutBtn{background:#00aaff;margin-top:20px;}
.payout-note{
  font-size:14px;
  color:#aaa;
  margin:15px 0;
  padding:10px;
  background:#222;
  border-radius:8px;
}
</style>
</head>
<body>
<div id="login">
  <h1>üìö Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>
<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>
  <div>
    <button class="tab-btn active" onclick="openTab('store')">Store</button>
    <button class="tab-btn" onclick="openTab('purchases')">My Purchases</button>
    <button class="tab-btn" onclick="openTab('sales')">My Sales</button>
  </div>
  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <h3>Add Book</h3>
      <input id="title" placeholder="Book title">
      <input id="price" type="number" placeholder="Price (Pi)">
      <textarea id="description" placeholder="Book description (optional)" rows="3"></textarea>
      <select id="language">
        <option value="">Select language</option>
        <option value="English">English</option>
        <option value="Arabic">Arabic</option>
        <option value="French">French</option>
        <option value="Spanish">Spanish</option>
        <option value="German">German</option>
        <option value="Other">Other</option>
      </select>
      <p>Number of pages (optional)</p>
      <input id="manualPages" type="number" placeholder="e.g. 250" min="1">
      <p>üì∑ Book Cover (images only)</p>
      <button id="uploadCoverBtn">Upload Cover</button>
      <p id="coverStatus" class="upload-status"></p>
      <p>üìÑ Book File (PDF only)</p>
      <button id="uploadPdfBtn">Upload PDF</button>
      <p id="pdfStatus" class="upload-status"></p>
      <br><br>
      <label class="notice">
        <input type="checkbox" id="rights">
        I confirm that I own all rights to this book
      </label><br><br>
      <button id="saveBookBtn" onclick="saveBook()" disabled>Save Book</button>
    </div>
    <h3>All Books</h3>
    <input type="text" id="searchInput" placeholder="Search by book title..." oninput="searchBooks()">
    <div class="books" id="books"></div>
    <div class="disclaimer">
      Disclaimer: The website is not responsible for any copyright issues. Each user is fully responsible for the books they upload.
    </div>
  </div>
  <div id="purchases" class="tab-content">
    <h3>My Purchased Books</h3>
    <div class="books" id="myBooks"></div>
  </div>
  <div id="sales" class="tab-content">
    <h3>My Sales & Earnings</h3>
    <p>Platform fee: 30% ‚Äì You get 70% of each sale</p>
    <p>Minimum payout: 5 Pi</p>
    <div class="payout-note">
      <strong>Payout processing time:</strong> Payments are processed manually and can take from 1-2 days up to a maximum of 30 days, depending on volume.
    </div>
    <div id="mySalesBooks"></div>
    <div id="totalEarnings" class="total-profit"></div>
    <button id="payoutBtn" onclick="requestPayout()">Request Payout</button>
  </div>
</div>
<script>
/* ================= FIREBASE (read only) ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

/* ================= PI MAINNET ================= */
Pi.init({ version: "2.0", sandbox: false });
let user = null;
let userUid = null;

/* ================= CLOUDINARY WIDGET ================= */
let coverUrl = "";
let pdfUrl = "";
let pageCount = "Unknown";
const coverWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "covers",
  cropping: false,
  multiple: false,
  resourceType: "image",
  clientAllowedFormats: ["jpg", "jpeg", "png", "gif", "webp"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    coverUrl = result.info.secure_url;
    document.getElementById("coverStatus").innerText = "Cover uploaded successfully!";
    checkSaveReady();
  } else if (error) {
    alert("Cover upload failed: Please select an image file (jpg, png, etc.).");
  }
});
const pdfWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "pdfs",
  cropping: false,
  multiple: false,
  resourceType: "raw",
  clientAllowedFormats: ["pdf"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    pdfUrl = result.info.secure_url;
    pageCount = result.info.pages || "Unknown";
    document.getElementById("pdfStatus").innerText = "PDF uploaded successfully!" + (result.info.pages ? ` Pages: ${result.info.pages}` : "");
    checkSaveReady();
  } else if (error) {
    alert("PDF upload failed: Please select a PDF file only.");
  }
});
document.getElementById("uploadCoverBtn").addEventListener("click", () => coverWidget.open());
document.getElementById("uploadPdfBtn").addEventListener("click", () => pdfWidget.open());
function checkSaveReady() {
  if (coverUrl && pdfUrl) {
    document.getElementById("saveBookBtn").disabled = false;
  }
}

/* ================= BACKEND URL ================= */
const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

/* ================= SAVE BOOK (via backend) ================= */
async function saveBook() {
  if(!rights.checked) return alert("Please confirm that you own all rights to this book");
  const titleVal = title.value.trim();
  const priceVal = Number(price.value);
  const descVal = description.value.trim();
  const langVal = language.value;
  const manualPagesVal = manualPages.value.trim();
  if(!titleVal || !priceVal || !coverUrl || !pdfUrl) return alert("Please complete all fields and upload files");
  const finalPageCount = manualPagesVal || pageCount;
  const saveBtn = document.getElementById("saveBookBtn");
  saveBtn.disabled = true;
  saveBtn.innerText = "Saving...";
  try {
    const res = await fetch(`${BACKEND_URL}/save-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title: titleVal,
        price: priceVal,
        description: descVal,
        language: langVal,
        pageCount: finalPageCount,
        cover: coverUrl,
        pdf: pdfUrl,
        owner: user.username,
        ownerUid: userUid
      })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Save failed");
    }
    alert("Book uploaded successfully!");
    addBook.classList.add("hidden");
    coverUrl = "";
    pdfUrl = "";
    pageCount = "Unknown";
    manualPages.value = "";
    document.getElementById("coverStatus").innerText = "";
    document.getElementById("pdfStatus").innerText = "";
    loadBooks();
    loadMySales();
  } catch (e) {
    console.error(e);
    alert("Save failed: " + e.message);
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerText = "Save Book";
  }
}

/* ================= RATE BOOK (via backend) ================= */
async function rateBook(bookId, voteType, button) {
  if (!userUid) {
    alert("Please log in to rate books.");
    return;
  }
  try {
    const res = await fetch(`${BACKEND_URL}/rate-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, voteType, userUid })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Rating failed");
    }
    button.disabled = true;
    button.classList.add(voteType === 'like' ? 'liked' : 'disliked');
    const sibling = button.parentNode.querySelector(voteType === 'like' ? '.dislike-btn' : '.like-btn');
    if (sibling) sibling.disabled = true;
    loadBooks();
    loadMyPurchases();
  } catch (e) {
    console.error("Rating error:", e);
    alert("Failed to submit rating.");
  }
}

/* ================= BUY (ÿ™ÿ£ŸÉŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπÿ®ÿ± backend) ================= */
async function buy(bookId, price){
  if(!confirm(`Do you want to buy this book for ${price} Pi?`)) return;
  try {
    await Pi.createPayment(
      {
        amount: price,
        currency: "Pi",
        memo: "Book purchase from Spicy Library",
        metadata: { bookId, userUid }
      },
      {
        onReadyForServerApproval: async (paymentId) => {
          try {
            const res = await fetch(`${BACKEND_URL}/approve-payment`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            if (!res.ok) throw new Error(await res.text());
          } catch (err) {
            console.error("Approve failed:", err);
          }
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          try {
            const response = await fetch(`${BACKEND_URL}/complete-payment`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid, bookId, userUid })
            });
            if (!response.ok) {
              const errorData = await response.json();
              alert("Payment completion failed!\nDetails: " + JSON.stringify(errorData));
              return;
            }
            const data = await response.json();
            window.open(data.pdfUrl, "_blank");
            alert("Payment successful! The book is now open üìö");
            loadBooks();
            loadMyPurchases();
            loadMySales();
          } catch (err) {
            alert("Server connection error during payment completion.");
          }
        },
        onCancel: () => alert("Payment cancelled"),
        onError: (error, payment) => {
          alert("Payment error: " + error.message);
        }
      }
    );
  } catch (e) {
    alert("Failed to start payment process. Make sure you are using the Pi Browser.");
  }
}

/* ================= DOWNLOAD PDF (via backend) ================= */
async function downloadPdf(bookId) {
  try {
    const res = await fetch(`${BACKEND_URL}/get-pdf`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, userUid })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "Access denied");
    window.open(data.pdfUrl, "_blank");
  } catch (e) {
    alert("Download failed.");
  }
}

/* ================= REQUEST PAYOUT (reset via backend) ================= */
async function requestPayout() {
  const totalEarnings = parseFloat(document.getElementById("totalEarnings").innerText.replace("Total earnings: ", "").replace(" Pi", "")) || 0;
  if (totalEarnings < 5) {
    alert("Minimum payout is 5 Pi.\nWait for more sales before requesting withdrawal.");
    return;
  }
  const walletAddress = prompt(`Your current earnings: ${totalEarnings.toFixed(2)} Pi\n\nEnter your Pi Wallet address to request payout:`);
  if (!walletAddress || walletAddress.trim() === "") {
    alert("Wallet address is required.");
    return;
  }
  const payoutBtn = document.getElementById("payoutBtn");
  payoutBtn.disabled = true;
  try {
    await db.collection("payout_requests").add({
      username: user.username,
      earnings: totalEarnings.toFixed(2),
      walletAddress: walletAddress.trim(),
      requestedAt: Date.now(),
      status: "pending"
    });
    const res = await fetch(`${BACKEND_URL}/reset-sales`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user.username })
    });
    if (!res.ok) throw new Error("Reset failed");
    alert("Payout request sent successfully!\nYour earnings have been reset to zero.");
    loadMySales();
  } catch (e) {
    console.error("Payout request error:", e);
    alert("Failed to send request. Check your connection and try again.\nYour earnings are safe and not reset.");
  } finally {
    payoutBtn.disabled = false;
  }
}

/* ================= LOGIN ================= */
loginBtn.onclick = async () => {
  try {
    const auth = await Pi.authenticate(["username","payments"], onIncompletePaymentFound);
    user = auth.user;
    userUid = auth.user.uid;
    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + user.username;
    loadBooks();
    loadMyPurchases();
    loadMySales();
  } catch (e) {
    alert("Please open this app inside the Pi Browser only!");
  }
};
function logout(){
  location.reload();
}

/* ================= TABS ================= */
function openTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
  if (tabName === 'purchases') loadMyPurchases();
  if (tabName === 'sales') loadMySales();
}

/* ================= SEARCH BOOKS ================= */
function searchBooks() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const books = document.querySelectorAll("#books .book");
  let found = false;
  books.forEach(book => {
    const title = book.querySelector("h4").textContent.toLowerCase();
    if (title.includes(input)) {
      book.style.display = "block";
      found = true;
    } else {
      book.style.display = "none";
    }
  });
  if (!found && input) {
    if (!document.querySelector("#books p")) {
      document.getElementById("books").innerHTML += "<p>No books found.</p>";
    }
  }
}

/* ================= LOAD ALL BOOKS ================= */
async function loadBooks(){
  const box = document.getElementById("books");
  box.innerHTML = "<p>Loading books...</p>";
  try {
    const snap = await db.collection("books").get();
    box.innerHTML = "";
    if (snap.empty) {
      box.innerHTML = "<p>No books available yet.</p>";
      return;
    }
    for (const doc of snap.docs) {
      const b = doc.data();
      const bookId = doc.id;
      const desc = b.description || "No description";
      const lang = b.language ? `Language: ${b.language}` : "";
      const owner = b.owner ? `By: ${b.owner}` : "";
      const pages = b.pageCount && b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";
      let likes = 0;
      let dislikes = 0;
      let userVote = null;
      try {
        const ratingsSnap = await db.collection("ratings").doc(bookId).collection("votes").get();
        likes = ratingsSnap.docs.filter(d => d.data().vote === "like").length;
        dislikes = ratingsSnap.docs.filter(d => d.data().vote === "dislike").length;
        if (userUid) {
          const userVoteDoc = await db.collection("ratings").doc(bookId).collection("votes").doc(userUid).get();
          userVote = userVoteDoc.exists ? userVoteDoc.data().vote : null;
        }
      } catch (ratingErr) {
        console.error("Error loading ratings:", ratingErr);
      }
      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}">
          <h4>${b.title}</h4>
          <p>${b.price} Pi</p>
          <div class="description">${desc}</div>
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          <div class="ratings">
            <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${bookId}', 'like', this)" ${userVote ? 'disabled' : ''}>üëç</button> ${likes}
            <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${bookId}', 'dislike', this)" ${userVote ? 'disabled' : ''}>üëé</button> ${dislikes}
          </div>
          <button onclick="buy('${bookId}', ${b.price})">
            Buy with Pi
          </button>
        </div>`;
    }
  } catch (e) {
    console.error(e);
    box.innerHTML = "<p>Error loading books. Retrying in 5 seconds...</p>";
    setTimeout(loadBooks, 5000);
  }
}

/* ================= LOAD MY PURCHASES ================= */
async function loadMyPurchases(){
  const box = document.getElementById("myBooks");
  box.innerHTML = "<p>Loading your purchases...</p>";
  if (!userUid) {
    box.innerHTML = "<p>Please log in again.</p>";
    return;
  }
  try {
    const purchasesSnap = await db.collection("purchases").doc(userUid).collection("books").get();
    if (purchasesSnap.empty) {
      box.innerHTML = "<p>You haven't purchased any books yet.</p>";
      return;
    }
    box.innerHTML = "";
    for (const purchaseDoc of purchasesSnap.docs) {
      const bookId = purchaseDoc.id;
      const bookDoc = await db.collection("books").doc(bookId).get();
      if (bookDoc.exists) {
        const b = bookDoc.data();
        const desc = b.description || "No description";
        const lang = b.language ? `Language: ${b.language}` : "";
        const owner = b.owner ? `By: ${b.owner}` : "";
        const pages = b.pageCount && b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
        const sales = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";
        let likes = 0;
        let dislikes = 0;
        let userVote = null;
        try {
          const ratingsSnap = await db.collection("ratings").doc(bookId).collection("votes").get();
          likes = ratingsSnap.docs.filter(d => d.data().vote === "like").length;
          dislikes = ratingsSnap.docs.filter(d => d.data().vote === "dislike").length;
          const userVoteDoc = await db.collection("ratings").doc(bookId).collection("votes").doc(userUid).get();
          userVote = userVoteDoc.exists ? userVoteDoc.data().vote : null;
        } catch (ratingErr) {
          console.error("Error loading ratings:", ratingErr);
        }
        box.innerHTML += `
          <div class="book">
            <img src="${b.cover}">
            <h4>${b.title}</h4>
            <div class="description">${desc}</div>
            <div class="owner">${owner}</div>
            <div class="language">${lang}</div>
            <div class="pages">${pages}</div>
            <div class="sales">${sales}</div>
            <div class="ratings">
              <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${bookId}', 'like', this)" ${userVote ? 'disabled' : ''}>üëç</button> ${likes}
              <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${bookId}', 'dislike', this)" ${userVote ? 'disabled' : ''}>üëé</button> ${dislikes}
            </div>
            <button onclick="downloadPdf('${bookId}')">
              Download PDF
            </button>
          </div>`;
      }
    }
  } catch (e) {
    console.error(e);
    box.innerHTML = "<p>Error loading purchases. Retrying in 5 seconds...</p>";
    setTimeout(loadMyPurchases, 5000);
  }
}

/* ================= LOAD MY SALES ================= */
async function loadMySales() {
  const box = document.getElementById("mySalesBooks");
  const totalBox = document.getElementById("totalEarnings");
  box.innerHTML = "<p>Loading your sales...</p>";
  totalBox.innerHTML = "";
  if (!userUid) {
    box.innerHTML = "<p>Please log in again.</p>";
    return;
  }
  try {
    const booksSnap = await db.collection("books").where("owner", "==", user.username).get();
    if (booksSnap.empty) {
      box.innerHTML = "<p>You haven't uploaded any books yet.</p>";
      totalBox.innerHTML = "<p>Total earnings: 0 Pi</p>";
      document.getElementById("payoutBtn").disabled = true;
      return;
    }
    box.innerHTML = "";
    let totalEarnings = 0;
    for (const bookDoc of booksSnap.docs) {
      const b = bookDoc.data();
      const sales = b.salesCount || 0;
      const sellerProfit = sales * b.price * 0.7;
      totalEarnings += sellerProfit;
      box.innerHTML += `
        <div class="sales-book">
          <img src="${b.cover}" style="width:150px; border-radius:6px;">
          <h4>${b.title}</h4>
          <p>Price: ${b.price} Pi</p>
          <p>Sales: ${sales}</p>
          <div class="profit">Your earnings: ${sellerProfit.toFixed(2)} Pi (70%)</div>
        </div>`;
    }
    totalBox.innerHTML = `<div class="total-profit">Total earnings: ${totalEarnings.toFixed(2)} Pi</div>`;
    document.getElementById("payoutBtn").disabled = totalEarnings < 5;
  } catch (e) {
    console.error(e);
    box.innerHTML = "<p>Error loading sales.</p>";
  }
}

/* ================= HANDLE INCOMPLETE PAYMENT ================= */
async function onIncompletePaymentFound(incompletePayment) {
  alert("A previous pending payment was detected... Attempting to complete it automatically");
  try {
    const response = await fetch(`${BACKEND_URL}/complete-payment`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        paymentId: incompletePayment.identifier,
        txid: incompletePayment.transaction?.txid
      })
    });
    if (!response.ok) {
      alert("Failed to automatically complete the pending payment.\nPlease go to developers.minepi.com to complete or cancel it manually.");
      return;
    }
    alert("Pending payment completed successfully!\nYou can now make new purchases.");
  } catch (err) {
    alert("Error completing pending payment.\nPlease try again or complete it manually from the developer dashboard.");
  }
}

function toggleAdd(){
  addBook.classList.toggle("hidden");
}
</script>
</body>
</html>
