<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title> Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  background:#0f0f0f;
  color:#fff;
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
  text-align:center;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#ff4500;
  color:white;
  margin:6px;
}
.hidden{display:none;}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}
.book{
  background:#1c1c1c;
  border:1px solid #333;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px;
}
.book img{
  width:200px;
  border-radius:6px;
}
input,textarea{
  width:90%;
  padding:8px;
  margin:5px;
  border-radius:5px;
  border:none;
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <h1>üå∂Ô∏è Spicy Library</h1>
  <p>Login with Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<!-- APP SCREEN -->
<div id="appScreen" class="hidden">
  <h2 id="welcome"></h2>
  <button onclick="toggleAddBook()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>

  <!-- ADD BOOK -->
  <div id="addBook" class="hidden">
    <h3>Add Your Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <input type="file" id="cover" accept="image/*">
    <input type="file" id="pdf" accept="application/pdf">
    <textarea id="desc" placeholder="Description"></textarea>
    <label>
      <input type="checkbox" id="rights">
      I confirm I own all rights to this book
    </label><br>
    <button onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54",
  storageBucket: "spicy-97f54.firebasestorage.app",
  messagingSenderId: "15493400338",
  appId: "1:15493400338:web:0551a61592e3c4642455cb"
});

const db = firebase.firestore();
const storage = firebase.storage();

/* ================= Pi Network ================= */
Pi.init({ version: "2.0" }); // ‚ùå ÿ®ÿØŸàŸÜ sandbox

let user = null;

/* ================= LOGIN ================= */
document.getElementById("loginBtn").onclick = async ()=>{
  try{
    const auth = await Pi.authenticate(["username","payments"]);

    if(!auth || !auth.user){
      alert("Login cancelled");
      return;
    }

    user = auth.user;

    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    document.getElementById("welcome").innerText =
      "Welcome " + user.username;

    loadBooks();

  }catch(e){
    console.error(e);
    alert("Login failed. Open only in Pi Browser.");
  }
};

function logout(){
  location.reload();
}

/* ================= BOOKS ================= */
async function loadBooks(){
  const snap = await db.collection("books").get();
  const box = document.getElementById("books");
  box.innerHTML="";
  snap.forEach(doc=>{
    const b = doc.data();
    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buyBook('${doc.id}', ${b.price}, '${b.title}')">
          Buy
        </button>
      </div>`;
  });
}

function toggleAddBook(){
  document.getElementById("addBook").classList.toggle("hidden");
}

/* ================= UPLOAD BOOK ================= */
async function uploadBook(){
  if(!document.getElementById("rights").checked){
    alert("You must confirm rights");
    return;
  }

  const title = document.getElementById("title").value;
  const price = Number(document.getElementById("price").value);
  const desc = document.getElementById("desc").value;
  const coverFile = document.getElementById("cover").files[0];
  const pdfFile = document.getElementById("pdf").files[0];

  if(!title || !price || !coverFile || !pdfFile){
    alert("Fill all fields");
    return;
  }

  const coverRef = storage.ref("covers/"+Date.now()+"_"+coverFile.name);
  const pdfRef = storage.ref("pdfs/"+Date.now()+"_"+pdfFile.name);

  await coverRef.put(coverFile);
  await pdfRef.put(pdfFile);

  const coverURL = await coverRef.getDownloadURL();
  const pdfURL = await pdfRef.getDownloadURL();

  await db.collection("books").add({
    title,
    price,
    desc,
    cover: coverURL,
    pdf: pdfURL,
    owner: user.username,
    created: Date.now()
  });

  alert("Book uploaded successfully");
  toggleAddBook();
  loadBooks();
}

/* ================= PAYMENT ================= */
async function buyBook(id, price, title){
  try{
    await Pi.createPayment({
      amount: price,
      currency: "Pi",
      memo: "Buy book: " + title,
      metadata: { bookId: id }
    },{
      onReadyForServerCompletion(){
        alert("Payment successful");
      },
      onCancelled(){
        alert("Payment cancelled");
      },
      onError(e){
        alert("Payment error");
        console.error(e);
      }
    });
  }catch(e){
    alert("Payment failed");
    console.error(e);
  }
}
</script>

</body>
</html>
