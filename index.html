<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Spicy Library</title>
<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Cloudinary Widget -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
/* Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;margin:10px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
.book h4{margin:10px 0 5px;}
.book p{margin:5px 0;}
.description{font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
.owner{font-size:12px;color:#ff4500;}
.language{font-size:12px;color:#aaa;}
.pages{font-size:12px;color:#0f9;font-weight:bold;}
.sales{font-size:12px;color:#ffd700;font-weight:bold;}
.ratings{font-size:14px;margin:8px 0;}
.like-btn, .dislike-btn{background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
.like-btn.liked, .dislike-btn.disliked{opacity:0.6;}
.notice{font-size:14px;color:#ccc;}
.tab-btn{background:#333;margin:10px;padding:10px 20px;}
.tab-btn.active{background:#ff4500;}
.tab-content{display:none;}
.tab-content.active{display:block;}
#searchInput{width:80%;margin:10px auto;display:block;}
.disclaimer{font-size:12px;color:#ccc;margin-top:20px;padding:10px;border-top:1px solid #333;}
.upload-status{font-size:14px;color:#0f0;margin:10px 0;}
.sales-book{background:#222;border:1px solid #444;border-radius:8px;padding:15px;margin:20px auto;width:90%;max-width:500px;}
.sales-book h4{margin:10px 0;}
.profit{font-size:16px;color:#0f9;font-weight:bold;}
.total-profit{font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
#payoutBtn{background:#00aaff;margin-top:20px;}
</style>
</head>
<body>
<!-- Ù†ÙØ³ Ø§Ù„Ù€ HTML Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
<!-- LOGIN, APP, TABS, STORE, PURCHASES, SALES ØªØ¨ÙˆÙŠØ¨ Ù…Ø¹ payoutBtn -->
<!-- ... (Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚) ... -->

<script>
/* ================= FIREBASE, PI, CLOUDINARY (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚) ================= */

/* ================= REQUEST PAYOUT (Ù…Ø¹ ØªØµÙÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙ‚Ø·) ================= */
async function requestPayout() {
  const totalEarnings = parseFloat(document.getElementById("totalEarnings").innerText.replace("Total earnings: ", "").replace(" Pi", "")) || 0;

  if (totalEarnings <= 0) {
    alert("No earnings to withdraw yet.");
    return;
  }

  const walletAddress = prompt(`Your current earnings: ${totalEarnings.toFixed(2)} Pi\n\nEnter your Pi Wallet address to request payout:`);

  if (!walletAddress || walletAddress.trim() === "") {
    alert("Wallet address is required.");
    return;
  }

  const payoutBtn = document.getElementById("payoutBtn");
  payoutBtn.disabled = true;

  try {
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    await db.collection("payout_requests").add({
      username: user.username,
      earnings: totalEarnings.toFixed(2),
      walletAddress: walletAddress.trim(),
      requestedAt: Date.now(),
      status: "pending"
    });

    // Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â†’ ØªØµÙÙŠØ± salesCount Ù„ÙƒÙ„ ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø¦Ø¹
    const booksSnap = await db.collection("books").where("owner", "==", user.username).get();
    const batch = db.batch();

    booksSnap.forEach(doc => {
      batch.update(doc.ref, { salesCount: 0 });
    });

    await batch.commit();

    alert("Payout request sent successfully!\nYour earnings have been reset to zero.\nThe admin will process your payment soon.");

    loadMySales(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
  } catch (e) {
    console.error("Payout request error:", e);
    alert("Failed to send request. Check your connection and try again.\nYour earnings are safe and not reset.");
  } finally {
    payoutBtn.disabled = false;
  }
}

/* ================= LOAD MY SALES (ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ±) ================= */
async function loadMySales() {
  const box = document.getElementById("mySalesBooks");
  const totalBox = document.getElementById("totalEarnings");
  box.innerHTML = "<p>Loading your sales...</p>";
  totalBox.innerHTML = "";

  if (!userUid) {
    box.innerHTML = "<p>Please log in again.</p>";
    return;
  }

  try {
    const booksSnap = await db.collection("books").where("owner", "==", user.username).get();
    if (booksSnap.empty) {
      box.innerHTML = "<p>You haven't uploaded any books yet.</p>";
      totalBox.innerHTML = "<p>Total earnings: 0 Pi</p>";
      document.getElementById("payoutBtn").disabled = true;
      return;
    }

    box.innerHTML = "";
    let totalEarnings = 0;

    for (const bookDoc of booksSnap.docs) {
      const b = bookDoc.data();
      const sales = b.salesCount || 0;
      const sellerProfit = sales * b.price * 0.7;
      totalEarnings += sellerProfit;

      box.innerHTML += `
        <div class="sales-book">
          <img src="${b.cover}" style="width:150px; border-radius:6px;">
          <h4>${b.title}</h4>
          <p>Price: ${b.price} Pi</p>
          <p>Sales: ${sales}</p>
          <div class="profit">Your earnings: ${sellerProfit.toFixed(2)} Pi (70%)</div>
        </div>`;
    }

    totalBox.innerHTML = `<div class="total-profit">Total earnings: ${totalEarnings.toFixed(2)} Pi</div>`;
    document.getElementById("payoutBtn").disabled = totalEarnings <= 0;
  } catch (e) {
    console.error(e);
    box.innerHTML = "<p>Error loading sales.</p>";
  }
}

/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (loadBooks, buy, etc.) Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ù‹Ø§ */
</script>
</body>
</html>
