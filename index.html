<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸŒ¶ï¸ Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* Ù†ÙØ³ Ø§Ù„Ù€CSS Ø§Ù„Ø³Ø§Ø¨Ù‚ */
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input{padding:8px;margin:5px;width:90%;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;margin:10px;width:220px}
.book img{width:200px}
.notice{font-size:14px;color:#ccc;}
</style>
</head>
<body>
<!-- Ù†ÙØ³ Ø§Ù„Ù€HTML Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
<div id="login">
  <h1>ğŸŒ¶ï¸ Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>
<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Add Book</button>
  <button onclick="logout()">Logout</button>
  <div id="addBook" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <p>ğŸ“· Book Cover (image)</p>
    <input type="file" id="cover" accept="image/*">
    <p>ğŸ“„ Book File (PDF)</p>
    <input type="file" id="pdf" accept="application/pdf"><br><br>
    <label class="notice">
      <input type="checkbox" id="rights">
      I confirm that I fully own the rights to this book
    </label><br><br>
    <button id="uploadBtn" onclick="uploadBook()">Upload Book</button>
  </div>
  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();
Pi.init({version:"2.0", sandbox:false}); // Mainnet - Ø¯ÙØ¹ Ø­Ù‚ÙŠÙ‚ÙŠ
let user = null;

// Ø±Ø§Ø¨Ø· Cloud Function Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø³Ù†Ù†Ø´Ø¦Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
const COMMISSION_URL = "https://us-central1-spicy-97f54.cloudfunctions.net/recordCommission";

async function uploadCloudinary(file, folder){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET);
  fd.append("folder", folder);
  const r = await fetch(`https://api.cloudinary.com/v1_1/dkb0phegf/auto/upload`, {method:"POST", body:fd});
  const d = await r.json();
  return d.secure_url;
}

/* Ù†ÙØ³ Ø¯ÙˆØ§Ù„ login, logout, loadBooks, toggleAdd, uploadBook ÙƒÙ…Ø§ Ù‡ÙŠ */

/* Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø£Ø®Ø° Ø¹Ù…ÙˆÙ„Ø© */
async function buy(bookId, price){
  if (!confirm(`Ø³Ø¹Ø± Ø§Ù„ÙƒØªØ§Ø¨ ${price} Pi. Ø§Ù„Ù…Ù†ØµØ© ØªØ£Ø®Ø° 20% Ø¹Ù…ÙˆÙ„Ø©. Ù…ÙˆØ§ÙÙ‚ØŸ`)) return;

  try{
    await Pi.createPayment({
      amount: price,
      currency: "Pi",
      memo: "Buy book from Spicy Library",
      metadata: { bookId }
    },{
      onReadyForServerApproval: function(paymentId){},
      onReadyForServerCompletion: async function(paymentId, txid){
        // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹ØŒ Ù†Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù€backend
        const commission = price * 0.20; // 20% Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©
        const ownerEarning = price - commission;

        try {
          await fetch(COMMISSION_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              bookId,
              price,
              commission,
              ownerEarning,
              buyer: user.username,
              txid
            })
          });
          alert(`âœ… Payment successful! Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ${commission} Pi Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ù†ØµØ©`);
        } catch (err) {
          console.error(err);
          alert("Payment successful but commission recording failed");
        }

        const doc = await db.collection("books").doc(bookId).get();
        window.open(doc.data().pdf, "_blank");
      },
      onCancel: function(){ alert("Payment cancelled"); },
      onError: function(err){ alert("Payment error: " + err.message); }
    });
  }catch(e){
    alert("Payment failed");
  }
}
</script>
</body>
</html>
