<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spicy Library</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center}
button{background:#ff4500;color:#fff;border:none;padding:10px;border-radius:6px}
.hidden{display:none}
.book{background:#1c1c1c;padding:10px;margin:10px;border-radius:8px;width:220px}
.book img{width:200px}
.books{display:flex;flex-wrap:wrap;justify-content:center}
</style>
</head>

<body>

<div id="loginScreen">
  <h1>üå∂Ô∏è Spicy Library</h1>
  <button onclick="login()">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h2 id="welcome"></h2>
  <div class="books" id="books"></div>
</div>

<script>
// Firebase
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

// Pi
Pi.init({version:"2.0",sandbox:true});
let user=null;

// Login
async function login(){
  const auth = await Pi.authenticate(["username","payments"]);
  user = auth.user;
  loginScreen.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.innerText="Welcome "+user.username;
  loadBooks();
}

// Load Books
async function loadBooks(){
  books.innerHTML="";
  const snap = await db.collection("books").get();

  for(const doc of snap.docs){
    const b = doc.data();
    const purchased = await hasPurchased(doc.id);

    books.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        ${
          purchased
          ? `<a href="${b.pdf}" target="_blank"><button>Download</button></a>`
          : `<button onclick="buy('${doc.id}',${b.price})">Buy</button>`
        }
      </div>
    `;
  }
}

// Check purchase
async function hasPurchased(bookId){
  const q = await db.collection("purchases")
    .where("bookId","==",bookId)
    .where("buyer","==",user.username)
    .get();
  return !q.empty;
}

// Buy book
async function buy(bookId,price){
  Pi.createPayment({
    amount: price,
    currency: "Pi",
    memo: "Book purchase",
    metadata:{bookId}
  },{
    onReadyForServerCompletion: async ()=>{
      await db.collection("purchases").add({
        bookId,
        buyer:user.username,
        paid:true,
        date:Date.now()
      });
      alert("Payment successful!");
      loadBooks();
    }
  });
}
</script>

</body>
</html>
