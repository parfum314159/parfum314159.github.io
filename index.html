<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“š Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;max-width:400px;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
.book h4{margin:10px 0 5px;}
.description{font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
.owner{font-size:12px;color:#ff4500;}
.language{font-size:12px;color:#aaa;}
.pages{font-size:12px;color:#0f9;font-weight:bold;}
.sales{font-size:12px;color:#ffd700;font-weight:bold;}
.ratings{font-size:14px;margin:8px 0;}
.like-btn, .dislike-btn{background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
.like-btn.liked, .dislike-btn.disliked{opacity:0.6;}
.notice{font-size:14px;color:#ccc;}
.tab-btn{background:#333;margin:10px;padding:10px 20px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
.tab-btn.active{background:#ff4500;}
.tab-content{display:none;}
.tab-content.active{display:block;}
#searchInput{width:80%;max-width:500px;margin:15px auto;display:block;padding:10px;}
.disclaimer{font-size:12px;color:#ccc;margin:20px;padding:10px;border-top:1px solid #333;}
.upload-status{font-size:14px;color:#0f9;margin:10px 0;}
.sales-book{background:#222;border:1px solid #444;border-radius:8px;padding:15px;margin:20px auto;width:90%;max-width:500px;}
.profit{font-size:16px;color:#0f9;font-weight:bold;}
.total-profit{font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
#payoutBtn{background:#00aaff;font-size:16px;padding:15px 30px;margin-top:20px;}
.payout-note{font-size:14px;color:#aaa;margin:15px 0;padding:10px;background:#222;border-radius:8px;}
</style>
</head>
<body>

<div id="login">
  <h1>ðŸ“š Spicy Library</h1>
  <p class="notice">Login using Pi Network (must be in Pi Browser)</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">âž• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div>
    <button class="tab-btn active" onclick="openTab('store')">Store</button>
    <button class="tab-btn" onclick="openTab('purchases')">My Purchases</button>
    <button class="tab-btn" onclick="openTab('sales')">My Sales</button>
  </div>

  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <h3>Add Book</h3>
      <input id="title" placeholder="Book title">
      <input id="price" type="number" min="0.1" step="0.1" placeholder="Price (Pi)">
      <textarea id="description" placeholder="Book description (optional)" rows="3"></textarea>
      <select id="language">
        <option value="">Select language</option>
        <option value="English">English</option>
        <option value="Arabic">Arabic</option>
        <option value="French">French</option>
        <option value="Spanish">Spanish</option>
        <option value="German">German</option>
        <option value="Other">Other</option>
      </select>
      <p>Number of pages (optional)</p>
      <input id="manualPages" type="number" placeholder="e.g. 250" min="1">
      <p>ðŸ“· Book Cover (images only)</p>
      <button id="uploadCoverBtn">Upload Cover</button>
      <p id="coverStatus" class="upload-status"></p>
      <p>ðŸ“„ Book File (PDF only)</p>
      <button id="uploadPdfBtn">Upload PDF</button>
      <p id="pdfStatus" class="upload-status"></p>
      <br><br>
      <label class="notice">
        <input type="checkbox" id="rights">
        I confirm that I own all rights to this book
      </label><br><br>
      <button id="saveBookBtn" disabled>Save Book</button>
    </div>

    <h3>All Books</h3>
    <input type="text" id="searchInput" placeholder="Search by book title..." oninput="searchBooks()">
    <div class="books" id="books"></div>

    <div class="disclaimer">
      Disclaimer: The website is not responsible for any copyright issues. Each user is fully responsible for the books they upload.
    </div>
  </div>

  <div id="purchases" class="tab-content">
    <h3>My Purchased Books</h3>
    <div class="books" id="myBooks"></div>
  </div>

  <div id="sales" class="tab-content">
    <h3>My Sales & Earnings</h3>
    <p>Platform fee: 30% â€“ You get 70% of each sale</p>
    <p>Minimum payout: 5 Pi</p>
    <div class="payout-note">
      <strong>Payout processing time:</strong> Payments are processed manually and can take from 1-2 days up to a maximum of 30 days, depending on volume.
    </div>
    <div id="mySalesBooks"></div>
    <div id="totalEarnings" class="total-profit">Loading earnings...</div>
    <button id="payoutBtn" onclick="requestPayout()" disabled>Request Payout</button>
  </div>
</div>

<script>
// ================= FIREBASE (read only) =================
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

// ================= PI SDK =================
Pi.init({ version: "2.0", sandbox: false });

let user = null;
let userUid = null;
let coverUrl = "";
let pdfUrl = "";
let pageCount = "Unknown";

const BACKEND_URL = "https://pi-backend-c8nz.onrender.com";

// ================= CLOUDINARY =================
const coverWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "covers",
  resourceType: "image",
  clientAllowedFormats: ["jpg", "jpeg", "png", "webp"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    coverUrl = result.info.secure_url;
    document.getElementById("coverStatus").innerText = "Cover uploaded!";
    checkSaveReady();
  }
});

const pdfWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "pdfs",
  resourceType: "raw",
  clientAllowedFormats: ["pdf"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    pdfUrl = result.info.secure_url;
    pageCount = result.info.pages || "Unknown";
    document.getElementById("pdfStatus").innerText = "PDF uploaded!" + (result.info.pages ? ` (Pages: ${result.info.pages})` : "");
    checkSaveReady();
  }
});

document.getElementById("uploadCoverBtn").onclick = () => coverWidget.open();
document.getElementById("uploadPdfBtn").onclick = () => pdfWidget.open();

function checkSaveReady() {
  document.getElementById("saveBookBtn").disabled = !(coverUrl && pdfUrl && user);
}

// ================= HANDLE INCOMPLETE PAYMENT =================
async function onIncompletePaymentFound(incompletePayment) {
  alert("A previous pending payment was detected... Attempting to complete it automatically");
  console.log("Incomplete payment found:", incompletePayment);

  try {
    const response = await fetch("https://pi-backend-c8nz.onrender.com/complete-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        paymentId: incompletePayment.identifier,
        txid: incompletePayment.transaction?.txid
      })
    });

    if (!response.ok) {
      const err = await response.json();
      console.error("Failed to complete pending payment:", err);
      alert("Failed to automatically complete the pending payment.\nPlease go to developers.minepi.com to complete or cancel it manually.");
      return;
    }

    alert("Pending payment completed successfully!\nYou can now make new purchases.");
  } catch (err) {
    console.error("Error completing pending payment:", err);
    alert("Error completing pending payment.\nPlease try again or complete it manually from the developer dashboard.");
  }
}
  
// ================= LOGIN =================
document.getElementById("loginBtn").onclick = async () => {
  try {
    const authResult = await Pi.authenticate(["username", "payments"], onIncompletePaymentFound);
    user = authResult.user;
    userUid = user.uid;

    document.getElementById("welcome").innerText = `Welcome, ${user.username}!`;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

    loadBooks();
    loadMyPurchases();
    loadMySales();
  } catch (err) {
    alert("Login failed. Open in Pi Browser.");
  }
};

function logout() {
  location.reload();
}

// ================= SAVE BOOK (via backend) =================
async function saveBook() {
  if (!user) return alert("Login required");
  if (!document.getElementById("rights").checked) return alert("Confirm rights");

  const title = document.getElementById("title").value.trim();
  const price = Number(document.getElementById("price").value);
  const description = document.getElementById("description").value.trim();
  const language = document.getElementById("language").value;
  const manualPages = document.getElementById("manualPages").value.trim();

  if (!title || price <= 0 || !coverUrl || !pdfUrl) return alert("Complete all fields");

  const finalPages = manualPages || pageCount;

  const btn = document.getElementById("saveBookBtn");
  btn.disabled = true;
  btn.innerText = "Saving...";

  try {
    const res = await fetch(`${BACKEND_URL}/save-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title, price, description, language, pageCount: finalPages,
        cover: coverUrl, pdf: pdfUrl, owner: user.username, ownerUid: userUid
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Upload failed");
    }

    alert("Book uploaded successfully!");
    toggleAdd();
    coverUrl = pdfUrl = "";
    document.getElementById("coverStatus").innerText = "";
    document.getElementById("pdfStatus").innerText = "";
    checkSaveReady();
    loadBooks();
    loadMySales();
  } catch (e) {
    alert("Upload failed: " + e.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "Save Book";
  }
}

// ================= RATE BOOK (via backend) =================
async function rateBook(bookId, voteType, button) {
  if (!userUid) return alert("Login required");
  try {
    const res = await fetch(`${BACKEND_URL}/rate-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, voteType, userUid })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Rating failed");
    }

    button.disabled = true;
    button.classList.add(voteType === 'like' ? 'liked' : 'disliked');
    const sibling = button.parentNode.querySelector(voteType === 'like' ? '.dislike-btn' : '.like-btn');
    if (sibling) sibling.disabled = true;
    loadBooks();
    loadMyPurchases();
  } catch (e) {
    alert("Rating failed: " + e.message);
  }
}

// ================= BUY (ØªØ£ÙƒÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒØ§Ù…Ù„) =================
async function buy(bookId, price){
  if(!confirm(`Do you want to buy this book for ${price} Pi?`)) return;

  try {
    await Pi.createPayment(
      {
        amount: price,
        currency: "Pi",
        memo: "Book purchase from Spicy Library",
        metadata: { bookId }
      },
      {
        onReadyForServerApproval: async (paymentId) => {
          console.log("Approving payment:", paymentId);
          try {
            const res = await fetch("https://pi-backend-c8nz.onrender.com/approve-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            if (!res.ok) throw new Error(await res.text());
          } catch (err) {
            console.error("Approve failed:", err);
          }
        },

        onReadyForServerCompletion: async (paymentId, txid) => {
          console.log("Completing payment:", paymentId, "txid:", txid);
          try {
            const response = await fetch("https://pi-backend-c8nz.onrender.com/complete-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Completion failed:", errorData);
              alert("Payment completion failed!\nDetails: " + JSON.stringify(errorData));
              return;
            }

            await db.collection("purchases").doc(userUid).collection("books").doc(bookId).set({
              purchasedAt: Date.now()
            });

            const bookRef = db.collection("books").doc(bookId);
            await db.runTransaction(async (transaction) => {
              const bookDoc = await transaction.get(bookRef);
              if (!bookDoc.exists) throw "Book does not exist!";
              const newSales = (bookDoc.data().salesCount || 0) + 1;
              transaction.update(bookRef, { salesCount: newSales });
            });

            const bookDoc = await db.collection("books").doc(bookId).get();
            if (bookDoc.exists) {
              const pdfUrl = bookDoc.data().pdf;
              window.open(pdfUrl, "_blank");
            }

            alert("Payment successful! The book is now open ðŸ“š");

            loadBooks();
            loadMyPurchases();
            loadMySales();
          } catch (err) {
            console.error("Completion error:", err);
            alert("Server connection error during payment completion.");
          }
        },

        onCancel: () => alert("Payment cancelled"),

        onError: (error, payment) => {
          console.error("Pi Payment Error:", error, payment);
          alert("Payment error: " + error.message);
        }
      }
    );
  } catch (e) {
    console.error("Payment initiation failed:", e);
    alert("Failed to start payment process. Make sure you are using the Pi Browser.");
  }
}
</script>
</body>
</html>
