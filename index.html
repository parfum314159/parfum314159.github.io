<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“š Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Cloudinary -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center;gap:15px}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;width:220px}
.book img{width:200px;border-radius:6px}
.tab-btn{background:#333;margin:5px}
.tab-btn.active{background:#ff4500}
.tab-content{display:none}
.tab-content.active{display:block}
input,textarea{padding:8px;width:90%;margin:5px}
</style>
</head>
<body>

<div id="login">
  <h1>ðŸ“š Spicy Library</h1>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">âž• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div>
    <button class="tab-btn active" onclick="openTab('store')">Store</button>
    <button class="tab-btn" onclick="openTab('purchases')">My Purchases</button>
    <button class="tab-btn" onclick="openTab('sales')">My Sales</button>
  </div>

  <!-- STORE -->
  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <input id="title" placeholder="Title">
      <input id="price" type="number" placeholder="Price Pi">
      <textarea id="description" placeholder="Description"></textarea>

      <button id="uploadCoverBtn">Upload Cover</button>
      <p id="coverStatus"></p>

      <button id="uploadPdfBtn">Upload PDF</button>
      <p id="pdfStatus"></p>

      <label>
        <input type="checkbox" id="rights"> I own the rights
      </label><br><br>

      <button id="saveBookBtn" disabled>Save Book</button>
    </div>

    <h3>All Books</h3>
    <div id="books" class="books"></div>
  </div>

  <!-- PURCHASES -->
  <div id="purchases" class="tab-content">
    <h3>My Purchased Books</h3>
    <div id="myBooks" class="books"></div>
  </div>

  <!-- SALES -->
  <div id="sales" class="tab-content">
    <h3>My Sales</h3>
    <div id="mySalesBooks"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND = "https://pi-backend-c8nz.onrender.com";

/* ================= FIREBASE ================= */
// ðŸ”´ Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Firebase Console
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});

const auth = firebase.auth();

/* ================= PI ================= */
Pi.init({ version: "2.0", sandbox: false });

let piUser = null;
let coverUrl="", pdfUrl="";

/* ================= LOGIN ================= */
loginBtn.onclick = async () => {
  try {
    const piAuth = await Pi.authenticate(["username","payments"]);
    piUser = piAuth.user;

    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Firebase Ù…Ø®ØµØµ (Anonymous)
    const cred = await auth.signInAnonymously();
    const token = await cred.user.getIdToken();

    window.firebaseToken = token;

    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + piUser.username;

    loadBooks();
    loadMyPurchases();
    loadMySales();
  } catch (e) {
    alert("Open in Pi Browser");
  }
};

function logout(){ location.reload(); }

/* ================= AUTH HEADER ================= */
async function authHeader(){
  const token = await auth.currentUser.getIdToken();
  return {
    "Content-Type":"application/json",
    "Authorization":`Bearer ${token}`
  };
}

/* ================= CLOUDINARY ================= */
const coverWidget = cloudinary.createUploadWidget({
  cloudName:"dkb0phegf", uploadPreset:"spicy1998", folder:"covers"
},(_,r)=>{ if(r?.event==="success"){coverUrl=r.info.secure_url;coverStatus.innerText="Cover OK";check();}});

const pdfWidget = cloudinary.createUploadWidget({
  cloudName:"dkb0phegf", uploadPreset:"spicy1998", folder:"pdfs", resourceType:"raw"
},(_,r)=>{ if(r?.event==="success"){pdfUrl=r.info.secure_url;pdfStatus.innerText="PDF OK";check();}});

uploadCoverBtn.onclick=()=>coverWidget.open();
uploadPdfBtn.onclick=()=>pdfWidget.open();
function check(){ saveBookBtn.disabled=!(coverUrl&&pdfUrl); }

/* ================= SAVE BOOK ================= */
saveBookBtn.onclick = async () => {
  if(!rights.checked) return alert("Confirm rights");

  const res = await fetch(BACKEND+"/save-book",{
    method:"POST",
    headers: await authHeader(),
    body:JSON.stringify({
      title:title.value,
      price:price.value,
      description:description.value,
      cover:coverUrl,
      pdf:pdfUrl,
      owner:piUser.username
    })
  });

  const data = await res.json();
  if(data.success){
    alert("Book added");
    toggleAdd();
    loadBooks();
    loadMySales();
  }
};

/* ================= LOAD BOOKS ================= */
async function loadBooks(){
  const r = await fetch(BACKEND+"/books");
  const j = await r.json();
  books.innerHTML="";
  j.books.forEach(b=>{
    books.innerHTML+=`
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${b.id}',${b.price})">Buy</button>
      </div>`;
  });
}

/* ================= BUY ================= */
async function buy(bookId, price){
  await Pi.createPayment(
    {amount:price,currency:"Pi",metadata:{bookId}},
    {
      onReadyForServerApproval:(pid)=>
        fetch(BACKEND+"/approve-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId:pid})}),
      onReadyForServerCompletion:async(pid,txid)=>{
        const r=await fetch(BACKEND+"/complete-payment",{
          method:"POST",
          headers: await authHeader(),
          body:JSON.stringify({paymentId:pid,txid,bookId})
        });
        const d=await r.json();
        window.open(d.pdfUrl,"_blank");
        loadMyPurchases();
      }
    }
  );
}

/* ================= PURCHASES ================= */
async function loadMyPurchases(){
  const r=await fetch(BACKEND+"/my-purchases",{method:"POST",headers:await authHeader()});
  const j=await r.json();
  myBooks.innerHTML="";
  j.books.forEach(b=>{
    myBooks.innerHTML+=`
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <button onclick="downloadPdf('${b.id}')">Open</button>
      </div>`;
  });
}

/* ================= PDF ================= */
async function downloadPdf(bookId){
  const r=await fetch(BACKEND+"/get-pdf",{
    method:"POST",
    headers:await authHeader(),
    body:JSON.stringify({bookId})
  });
  const j=await r.json();
  window.open(j.pdfUrl,"_blank");
}

/* ================= SALES ================= */
async function loadMySales(){
  const r=await fetch(BACKEND+"/my-sales",{method:"POST",headers:await authHeader()});
  const j=await r.json();
  mySalesBooks.innerHTML="";
  j.books.forEach(b=>{
    mySalesBooks.innerHTML+=`<p>${b.title} â€“ Sales: ${b.salesCount}</p>`;
  });
}

/* ================= UI ================= */
function toggleAdd(){ addBook.classList.toggle("hidden"); }
function openTab(t){
  document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active"));
  document.getElementById(t).classList.add("active");
}
</script>

</body>
</html>
