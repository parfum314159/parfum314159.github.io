<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Spicy Library</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

<style>
/* === Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± === */
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;margin:10px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
</style>
</head>

<body>

<div id="login">
  <h1>ğŸ“š Spicy Library</h1>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div id="addBook" class="hidden">
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <textarea id="description" placeholder="Description"></textarea>

    <button id="uploadCoverBtn">Upload Cover</button>
    <p id="coverStatus"></p>

    <button id="uploadPdfBtn">Upload PDF</button>
    <p id="pdfStatus"></p>

    <label>
      <input type="checkbox" id="rights"> I own the rights
    </label>

    <button id="saveBookBtn" onclick="saveBook()" disabled>Save Book</button>
  </div>

  <h3>All Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://pi-backend-c8nz.onrender.com";
let user = null;
let userUid = null;

/* ================= PI ================= */
Pi.init({ version: "2.0", sandbox: false });

loginBtn.onclick = async () => {
  const auth = await Pi.authenticate(["username","payments"]);
  user = auth.user;
  userUid = auth.user.uid;

  login.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.innerText = "Welcome " + user.username;

  loadBooks();
};

/* ================= CLOUDINARY ================= */
let coverUrl = "";
let pdfUrl = "";

const coverWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "covers",
  resourceType: "image"
}, (_, result) => {
  if (result?.event === "success") {
    coverUrl = result.info.secure_url;
    coverStatus.innerText = "Cover uploaded";
    checkReady();
  }
});

const pdfWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "pdfs",
  resourceType: "raw"
}, (_, result) => {
  if (result?.event === "success") {
    pdfUrl = result.info.secure_url;
    pdfStatus.innerText = "PDF uploaded";
    checkReady();
  }
});

uploadCoverBtn.onclick = () => coverWidget.open();
uploadPdfBtn.onclick = () => pdfWidget.open();

function checkReady(){
  saveBookBtn.disabled = !(coverUrl && pdfUrl);
}

/* ================= SAVE BOOK (BACKEND) ================= */
async function saveBook(){
  if(!rights.checked) return alert("Confirm rights");

  const res = await fetch(API + "/save-book", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: title.value,
      price: price.value,
      description: description.value,
      cover: coverUrl,
      pdf: pdfUrl,
      owner: user.username
    })
  });

  const data = await res.json();
  if(data.success){
    alert("Book saved!");
    addBook.classList.add("hidden");
    loadBooks();
  } else {
    alert(data.error);
  }
}

/* ================= LOAD BOOKS (BACKEND) ================= */
async function loadBooks(){
  books.innerHTML = "Loading...";
  const res = await fetch(API + "/books");
  const data = await res.json();

  books.innerHTML = "";
  data.books.forEach(b => {
    books.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${b.id}', ${b.price})">Buy</button>
      </div>`;
  });
}

/* ================= BUY ================= */
async function buy(bookId, price){
  await Pi.createPayment(
    { amount: price, currency: "Pi", metadata:{bookId} },
    {
      onReadyForServerApproval: async (paymentId) => {
        await fetch(API + "/approve-payment", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(API + "/complete-payment", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ paymentId, txid, bookId, userUid })
        });
        const data = await res.json();
        window.open(data.pdfUrl, "_blank");
      }
    }
  );
}

function toggleAdd(){ addBook.classList.toggle("hidden"); }
function logout(){ location.reload(); }
</script>

</body>
</html>
