<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå∂Ô∏è Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  margin:0;
  padding:20px;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  background:#ff4500;
  color:#fff;
  cursor:pointer;
  margin:5px;
}
button:disabled{
  background:#555;
  cursor:not-allowed;
}
input{
  padding:8px;
  margin:5px;
  width:90%;
}
.hidden{display:none}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center
}
.book{
  background:#1c1c1c;
  border:1px solid #333;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px
}
.book img{width:200px}
.notice{
  font-size:14px;
  color:#ccc;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>üå∂Ô∏è Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>

  <div id="addBook" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <p>üì∑ Book Cover</p>
    <input type="file" id="cover" accept="image/*">
    <p>üìÑ Book File (PDF)</p>
    <input type="file" id="pdf" accept="application/pdf"><br><br>

    <label class="notice">
      <input type="checkbox" id="rights">
      I confirm that I fully own the rights to this book
    </label><br><br>

    <button id="uploadBtn" onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= INIT PI (FIX) ================= */
window.addEventListener("load", () => {
  Pi.init({ version: "2.0", sandbox: false });
});

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

let user = null;

/* ================= LOGIN (FIX) ================= */
loginBtn.onclick = async ()=>{
  try{
    const auth = await Pi.authenticate(
      ["payments"],
      onIncompletePaymentFound
    );
    user = auth.user;
    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + user.username;
    loadBooks();
  }catch(e){
    console.error(e);
    alert("Login failed. Use Pi Browser.");
  }
};

function onIncompletePaymentFound(payment){
  console.log("Incomplete payment found:", payment);
}

/* ================= ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± ================= */

function logout(){ location.reload(); }

async function loadBooks(){
  const box = document.getElementById("books");
  box.innerHTML = "";
  const snap = await db.collection("books").get();
  snap.forEach(doc=>{
    const b = doc.data();
    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${doc.id}', ${b.price})">Buy with Pi</button>
      </div>`;
  });
}

function toggleAdd(){ addBook.classList.toggle("hidden"); }

/* ================= BUY (WORKING) ================= */
function buy(bookId, price){
  Pi.createPayment(
    {
      amount: price,
      memo: "Purchase from Spicy Library",
      metadata: { bookId }
    },
    {
      onSuccess: async (payment)=>{
        alert("‚úÖ Payment successful");
        const doc = await db.collection("books").doc(bookId).get();
        if(doc.exists) window.open(doc.data().pdf, "_blank");
      },
      onCancel: ()=> alert("Payment cancelled"),
      onError: err=>{
        console.error(err);
        alert("Payment error");
      }
    }
  );
}
</script>

</body>
</html>
