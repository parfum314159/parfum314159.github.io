<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå∂Ô∏è Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  margin:0;
  padding:20px;
  text-align:center;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#ff4500;
  color:white;
  margin:5px;
}
.hidden{display:none;}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}
.book{
  background:#1c1c1c;
  border:1px solid #333;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:230px;
}
input,textarea{
  width:90%;
  padding:8px;
  margin:5px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <h1>üå∂Ô∏è Spicy Library</h1>
  <p>Login with Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<!-- APP -->
<div id="appScreen" class="hidden">
  <h2 id="welcome"></h2>
  <button onclick="toggleAddBook()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>

  <!-- ADD BOOK -->
  <div id="addBook" class="hidden">
    <h3>Add Your Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <input id="cover" placeholder="Cover Image URL">
    <input id="pdf" placeholder="PDF URL (protected)">
    <textarea id="desc" placeholder="Description"></textarea>
    <label>
      <input type="checkbox" id="rights">
      I confirm I own the rights
    </label><br>
    <button onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>üìö Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
// ================= CONFIG =================
const PLATFORM_WALLET = "spicy_platform";
const PLATFORM_FEE_PERCENT = 20; // 20%

// ================= Firebase =================
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

// ================= Pi =================
Pi.init({ version:"2.0", sandbox:true }); // ‚Üê ÿ∫ŸäŸëÿ± ÿ•ŸÑŸâ false ÿ®ÿπÿØ Mainnet

let user = null;

// ================= LOGIN =================
document.getElementById("loginBtn").onclick = async ()=>{
  try{
    const auth = await Pi.authenticate(["username","payments"]);
    user = auth.user;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    document.getElementById("welcome").innerText = "Welcome " + user.username;
    loadBooks();
  }catch(e){
    alert("Login failed");
  }
};

function logout(){ location.reload(); }

// ================= BOOKS =================
async function loadBooks(){
  const booksSnap = await db.collection("books").get();
  const purchasesSnap = await db.collection("purchases")
    .where("buyer","==",user.username).get();

  const owned = purchasesSnap.docs.map(d=>d.data().bookId);

  const box = document.getElementById("books");
  box.innerHTML="";

  booksSnap.forEach(doc=>{
    const b = doc.data();
    const isOwner = owned.includes(doc.id);

    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}" width="200"><br>
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        ${
          isOwner
          ? `<a href="${b.pdf}" target="_blank">
               <button>‚¨á Download</button>
             </a>`
          : `<button onclick="buy('${doc.id}','${b.title}',${b.price},'${b.owner}')">
               Buy
             </button>`
        }
      </div>`;
  });
}

// ================= ADD BOOK =================
function toggleAddBook(){
  document.getElementById("addBook").classList.toggle("hidden");
}

async function uploadBook(){
  if(!document.getElementById("rights").checked){
    alert("Confirm rights");
    return;
  }

  await db.collection("books").add({
    title: title.value,
    price: Number(price.value),
    desc: desc.value,
    cover: cover.value,
    pdf: pdf.value,
    owner: user.username
  });

  alert("Book added");
  toggleAddBook();
  loadBooks();
}

// ================= PAYMENT =================
async function buy(bookId,title,price,seller){
  const fee = price * PLATFORM_FEE_PERCENT / 100;
  const sellerAmount = price - fee;

  await Pi.createPayment({
    amount: price,
    currency: "Pi",
    memo: "Buy " + title,
    metadata: { bookId }
  },{
    onReadyForServerCompletion: async ()=>{
      await db.collection("purchases").add({
        bookId,
        buyer: user.username,
        paid: true,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });

      await db.collection("earnings").add({
        seller,
        bookId,
        amount: sellerAmount,
        fee,
        paidOut: false
      });

      alert("Payment successful");
      loadBooks();
    }
  });
}
</script>
</body>
</html>
