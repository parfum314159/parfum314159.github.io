<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
  body {background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
  button {padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
  button:disabled {background:#555;cursor:not-allowed;}
  input, textarea, select {padding:8px;margin:5px;width:90%;max-width:400px;}
  .hidden {display:none}
  .books {display:flex;flex-wrap:wrap;justify-content:center;gap:15px;}
  .book {background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;width:220px;font-size:14px;}
  .book img {width:200px;border-radius:6px;}
  .book h4 {margin:10px 0 5px;}
  .description {font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
  .owner {font-size:12px;color:#ff4500;}
  .language {font-size:12px;color:#aaa;}
  .pages {font-size:12px;color:#0f9;font-weight:bold;}
  .sales {font-size:12px;color:#ffd700;font-weight:bold;}
  .ratings {font-size:14px;margin:8px 0;}
  .like-btn, .dislike-btn {background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
  .like-btn.liked, .dislike-btn.disliked {opacity:0.6;}
  .tab-btn {background:#333;margin:10px;padding:10px 20px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
  .tab-btn.active {background:#ff4500;}
  .tab-content {display:none;}
  .tab-content.active {display:block;}
  #searchInput {width:80%;max-width:500px;margin:15px auto;display:block;padding:10px;}
  .disclaimer {font-size:12px;color:#ccc;margin:20px;padding:10px;border-top:1px solid #333;}
  .upload-status {font-size:14px;color:#0f9;margin:10px 0;}
  .total-profit {font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
  #payoutBtn {background:#00aaff;font-size:16px;padding:15px 30px;}
  .login-required {color:#f88;font-size:14px;margin:10px;}
</style>
</head>
<body>

<div id="login">
  <h1>ğŸ“š Spicy Library</h1>
  <p class="notice">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi Network Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div>
    <button class="tab-btn active" onclick="openTab('store')">Store</button>
    <button class="tab-btn" onclick="openTab('purchases')">My Purchases</button>
    <button class="tab-btn" onclick="openTab('sales')">My Sales</button>
  </div>

  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <h3>Add New Book</h3>
      <p class="login-required">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±ÙØ¹ ÙƒØªØ§Ø¨</p>
      <input id="title" placeholder="Book title">
      <input id="price" type="number" min="0.1" step="0.1" placeholder="Price (Pi)">
      <textarea id="description" placeholder="Book description (optional)" rows="3"></textarea>
      <select id="language">
        <option value="">Select language</option>
        <option value="English">English</option>
        <option value="Arabic">Arabic</option>
        <option value="French">French</option>
        <option value="Spanish">Spanish</option>
        <option value="German">German</option>
        <option value="Other">Other</option>
      </select>
      <p>Number of pages (optional)</p>
      <input id="manualPages" type="number" placeholder="e.g. 250" min="1">
      <p>ğŸ“· Book Cover (image only)</p>
      <button id="uploadCoverBtn">Upload Cover</button>
      <p id="coverStatus" class="upload-status"></p>
      <p>ğŸ“„ Book File (PDF only)</p>
      <button id="uploadPdfBtn">Upload PDF</button>
      <p id="pdfStatus" class="upload-status"></p>
      <br>
      <label>
        <input type="checkbox" id="rights"> 
        <strong>I confirm that I own all rights to this book and am responsible for its content</strong>
      </label>
      <br><br>
      <button id="saveBookBtn" disabled>Save Book</button>
    </div>

    <h3>All Books</h3>
    <input type="text" id="searchInput" placeholder="Search by title..." oninput="searchBooks()">
    <div class="books" id="books"></div>

    <div class="disclaimer">
      <strong>Disclaimer:</strong> The platform is not responsible for copyright violations. Each seller is fully responsible for the content they upload.
    </div>
  </div>

  <div id="purchases" class="tab-content">
    <h3>My Purchased Books</h3>
    <div class="books" id="myBooks"></div>
  </div>

  <div id="sales" class="tab-content">
    <h3>My Sales & Earnings</h3>
    <p>Platform fee: 30% â€“ You receive 70% of each sale</p>
    <p>Minimum payout: 5 Pi</p>
    <div class="payout-note" style="background:#222;padding:15px;border-radius:8px;margin:15px auto;max-width:600px;">
      <strong>Payout processing:</strong> Manual processing within 1â€“30 days depending on volume.
    </div>
    <div id="mySalesBooks"></div>
    <div id="totalEarnings" class="total-profit">Loading earnings...</div>
    <button id="payoutBtn" onclick="requestPayout()" disabled>Request Payout</button>
  </div>
</div>

<script>
// ================= FIREBASE CONFIG =================
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

// ================= PI SDK INIT =================
Pi.init({ version: "2.0", sandbox: false });

let user = null;        // Pi user object { uid, username }
let userUid = null;
let coverUrl = "";
let pdfUrl = "";
let pageCount = "Unknown";

// ================= CLOUDINARY WIDGETS =================
const coverWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "covers",
  resourceType: "image",
  clientAllowedFormats: ["jpg", "jpeg", "png", "webp"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    coverUrl = result.info.secure_url;
    document.getElementById("coverStatus").innerText = "âœ“ Cover uploaded!";
    checkSaveReady();
  }
});

const pdfWidget = cloudinary.createUploadWidget({
  cloudName: "dkb0phegf",
  uploadPreset: "spicy1998",
  folder: "pdfs",
  resourceType: "raw",
  clientAllowedFormats: ["pdf"]
}, (error, result) => {
  if (!error && result && result.event === "success") {
    pdfUrl = result.info.secure_url;
    pageCount = result.info.pages || "Unknown";
    document.getElementById("pdfStatus").innerText = 
      `âœ“ PDF uploaded! ${result.info.pages ? 'Pages: ' + result.info.pages : ''}`;
    checkSaveReady();
  }
});

document.getElementById("uploadCoverBtn").addEventListener("click", () => coverWidget.open());
document.getElementById("uploadPdfBtn").addEventListener("click", () => pdfWidget.open());

function checkSaveReady() {
  if (coverUrl && pdfUrl && user) {
    document.getElementById("saveBookBtn").disabled = false;
  }
}

// ================= AUTHENTICATION =================
async function authenticate() {
  try {
    const scopes = ['username', 'payments'];
    const authResult = await Pi.authenticate(scopes, onIncompletePaymentFound);
    user = authResult.user;
    userUid = user.uid;
    document.getElementById("welcome").innerText = `Welcome, ${user.username}!`;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadBooks();
    loadMyPurchases();
    loadMySales();
  } catch (err) {
    alert("Login failed: " + err.message);
    console.error(err);
  }
}

function logout() {
  user = null;
  userUid = null;
  document.getElementById("app").classList.add("hidden");
  document.getElementById("login").classList.remove("hidden");
}

// Login button
document.getElementById("loginBtn").onclick = authenticate;

// ================= SAVE BOOK =================
async function saveBook() {
  if (!user) return alert("Please log in first");
  if (!document.getElementById("rights").checked) return alert("You must confirm ownership rights");

  const title = document.getElementById("title").value.trim();
  const price = Number(document.getElementById("price").value);
  const description = document.getElementById("description").value.trim();
  const language = document.getElementById("language").value;
  const manualPages = document.getElementById("manualPages").value.trim();

  if (!title || !price || price <= 0 || !coverUrl || !pdfUrl) {
    return alert("Please fill all required fields and upload cover + PDF");
  }

  const finalPages = manualPages || pageCount;

  const btn = document.getElementById("saveBookBtn");
  btn.disabled = true;
  btn.innerText = "Saving...";

  try {
    await db.collection("books").add({
      title,
      price,
      description,
      language,
      pageCount: finalPages,
      salesCount: 0,
      cover: coverUrl,
      pdf: pdfUrl,
      owner: user.username,
      ownerUid: user.uid,
      createdAt: Date.now()
    });

    alert("Book uploaded successfully! ğŸ‰");
    resetUploadForm();
    loadBooks();
    loadMySales();
  } catch (e) {
    console.error(e);
    alert("Upload failed: " + e.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "Save Book";
  }
}

function resetUploadForm() {
  document.getElementById("addBook").classList.add("hidden");
  document.getElementById("title").value = "";
  document.getElementById("price").value = "";
  document.getElementById("description").value = "";
  document.getElementById("language").value = "";
  document.getElementById("manualPages").value = "";
  document.getElementById("rights").checked = false;
  coverUrl = ""; pdfUrl = ""; pageCount = "Unknown";
  document.getElementById("coverStatus").innerText = "";
  document.getElementById("pdfStatus").innerText = "";
  document.getElementById("saveBookBtn").disabled = true;
}

// Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ (loadBooks, buy, requestPayout, etc.) Ù…ØªØ´Ø§Ø¨Ù‡Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ù…Ø§Ù† Ø¨Ø³ÙŠØ·Ø©

// ... (Ø³Ø£Ø¶ÙŠÙ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‡Ù… Ù…Ø¹ Ø§Ø®ØªØµØ§Ø± Ù„Ù„Ø·ÙˆÙ„)

async function loadBooks() {
  const box = document.getElementById("books");
  box.innerHTML = "<p>Loading books...</p>";
  try {
    const snap = await db.collection("books").orderBy("createdAt", "desc").get();
    box.innerHTML = "";
    snap.forEach(doc => {
      const b = doc.data();
      const desc = b.description ? b.description.substring(0, 100) + "..." : "No description";
      const lang = b.language ? `Language: ${b.language}` : "";
      const owner = `By: ${b.owner}`;
      const pages = b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";

      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}" alt="cover">
          <h4>${b.title}</h4>
          <p><strong>${b.price} Pi</strong></p>
          <div class="description">${desc}</div>
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          ${user ? `<button onclick="buy('${doc.id}', ${b.price})">Buy with Pi</button>` : `<button disabled>Not logged in</button>`}
        </div>`;
    });
  } catch (e) {
    box.innerHTML = "<p>Error loading books.</p>";
  }
}

async function buy(bookId, price) {
  if (!user) return alert("Please log in to buy");
  if (!confirm(`Buy this book for ${price} Pi?`)) return;

  // Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ backend URL Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
  // ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ù€ URL Ø¥Ù„Ù‰ Ø§Ù„Ù€ Render Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
  const BACKEND_URL = "https://pi-backend-c8nz.onrender.com"; // ØºÙŠÙ‘Ø±Ù‡ Ø¥Ø°Ø§ ØªØºÙŠØ±

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Spicy Library Book Purchase",
      metadata: { bookId }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve-payment`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({paymentId})
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(`${BACKEND_URL}/complete-payment`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({paymentId, txid})
        });
        if (!res.ok) throw new Error(await res.text());

        // Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆÙØªØ­ PDF
        await db.collection("purchases").doc(userUid).collection("books").doc(bookId).set({purchasedAt: Date.now()});
        const bookDoc = await db.collection("books").doc(bookId).get();
        window.open(bookDoc.data().pdf, "_blank");
        alert("Payment successful! Book opened ğŸ“š");
        loadBooks(); loadMyPurchases(); loadMySales();
      },
      onCancel: () => alert("Payment cancelled"),
      onError: (err) => alert("Payment error: " + err.message)
    });
  } catch (e) {
    alert("Payment failed. Use Pi Browser.");
  }
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø«Ù„ loadMyPurchases, loadMySales, requestPayout, rateBook, openTab, toggleAdd, searchBooks
// ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ user != null Ø­ÙŠØ« ÙŠÙ„Ø²Ù…

function openTab(tabName) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add("active");

  if (tabName === "store") loadBooks();
  if (tabName === "purchases") loadMyPurchases();
  if (tabName === "sales") loadMySales();
}

function toggleAdd() {
  if (!user) return alert("Please log in to add a book");
  document.getElementById("addBook").classList.toggle("hidden");
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
</script>
</body>
</html>
