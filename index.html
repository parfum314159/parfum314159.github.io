<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spicy Library</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  padding:20px;
}
button{
  background:#ff4500;
  border:none;
  color:#fff;
  padding:10px 20px;
  margin:5px;
  border-radius:6px;
  cursor:pointer;
}
input,textarea{
  width:90%;
  padding:8px;
  margin:5px;
}
.hidden{display:none;}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}
.book{
  background:#1c1c1c;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px;
}
.book img{
  width:200px;
  border-radius:6px;
}
</style>
</head>

<body>

<div id="loginScreen">
  <h1>üå∂Ô∏è Spicy Library</h1>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="appScreen" class="hidden">
  <h2 id="welcome"></h2>
  <button onclick="toggleAdd()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>

  <div id="addBook" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <input type="file" id="coverFile" accept="image/*">
    <input type="file" id="pdfFile" accept="application/pdf">
    <textarea id="desc" placeholder="Description"></textarea>
    <label>
      <input type="checkbox" id="rights"> I own the rights
    </label><br>
    <button onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>üìö Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
// ================= Firebase =================
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  appId: "YOUR_APP_ID"
});

const db = firebase.firestore();
const storage = firebase.storage();

// ================= Pi =================
Pi.init({ version:"2.0", sandbox:true });

let user = null;

// LOGIN
loginBtn.onclick = async ()=>{
  const auth = await Pi.authenticate(["username","payments"]);
  user = auth.user;
  loginScreen.classList.add("hidden");
  appScreen.classList.remove("hidden");
  welcome.innerText = "Welcome " + user.username;
  loadBooks();
};

function logout(){ location.reload(); }
function toggleAdd(){ addBook.classList.toggle("hidden"); }

// ================= Upload Book =================
async function uploadBook(){
  if(!rights.checked) return alert("Confirm rights");

  const cover = coverFile.files[0];
  const pdf = pdfFile.files[0];

  const coverRef = storage.ref("covers/"+Date.now()+"_"+cover.name);
  const pdfRef = storage.ref("pdfs/"+Date.now()+"_"+pdf.name);

  await coverRef.put(cover);
  await pdfRef.put(pdf);

  const coverURL = await coverRef.getDownloadURL();
  const pdfURL = await pdfRef.getDownloadURL();

  await db.collection("books").add({
    title:title.value,
    price:Number(price.value),
    desc:desc.value,
    cover:coverURL,
    pdf:pdfURL
  });

  alert("Book uploaded");
  loadBooks();
}

// ================= Load Books =================
async function loadBooks(){
  const snap = await db.collection("books").get();
  books.innerHTML="";
  snap.forEach(doc=>{
    const b = doc.data();
    books.innerHTML += `
    <div class="book">
      <img src="${b.cover}">
      <h4>${b.title}</h4>
      <p>${b.price} Pi</p>
      <button onclick="buy('${doc.id}',${b.price})">Buy</button>
      <div id="dl-${doc.id}"></div>
    </div>`;
  });
}

// ================= Buy =================
async function buy(bookId, price){
  await Pi.createPayment({
    amount: price,
    currency: "Pi",
    memo: "Buy book"
  },{
    onReadyForServerCompletion: async ()=>{
      await db.collection("purchases").add({
        bookId,
        user:user.username
      });

      const book = await db.collection("books").doc(bookId).get();
      document.getElementById("dl-"+bookId).innerHTML =
        `<a href="${book.data().pdf}" target="_blank">
          <button>üì• Download PDF</button>
        </a>`;
    }
  });
}
</script>
</body>
</html>
