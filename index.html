<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Spicy Library</title>
<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
  margin:0;
  padding:20px;
}
button{
  padding:10px 20px;
  border:none;
  border-radius:6px;
  background:#ff4500;
  color:#fff;
  cursor:pointer;
  margin:5px;
}
button:disabled{
  background:#555;
  cursor:not-allowed;
}
input{
  padding:8px;
  margin:5px;
  width:90%;
}
.hidden{display:none}
.books{
  display:flex;
  flex-wrap:wrap;
  justify-content:center
}
.book{
  background:#1c1c1c;
  border:1px solid #333;
  border-radius:8px;
  padding:15px;
  margin:10px;
  width:220px
}
.book img{width:200px}
.notice{
  font-size:14px;
  color:#ccc;
}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="login">
  <h1>ğŸ“š Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Add Book</button>
  <button onclick="logout()">Logout</button>

  <!-- ADD BOOK -->
  <div id="addBook" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <p>ğŸ“· Book Cover</p>
    <input type="file" id="cover" accept="image/*">
    <p>ğŸ“„ Book File (PDF)</p>
    <input type="file" id="pdf" accept="application/pdf"><br><br>
    <label class="notice">
      <input type="checkbox" id="rights">
      I confirm that I own all rights to this book
    </label><br><br>
    <button id="uploadBtn" onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

/* ================= PI MAINNET ================= */
Pi.init({ version: "2.0", sandbox: false });
let user = null;

/* ================= CLOUDINARY ================= */
const CLOUD_NAME = "dkb0phegf";
const UPLOAD_PRESET = "spicy1998";

async function uploadCloudinary(file, folder){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET);
  fd.append("folder", folder);
  const r = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
    { method:"POST", body:fd }
  );
  const d = await r.json();
  return d.secure_url;
}

/* ================= LOGIN ================= */
loginBtn.onclick = async () => {
  try {
    const auth = await Pi.authenticate(["username","payments"], onIncompletePaymentFound);  // Ø£Ø¶ÙÙ†Ø§ onIncompletePaymentFound Ù‡Ù†Ø§
    user = auth.user;
    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + user.username;
    loadBooks();
  } catch (e) {
    alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Pi Browser ÙÙ‚Ø·!");
  }
};

function logout(){
  location.reload();
}

/* ================= BOOKS ================= */
async function loadBooks(){
  const box = document.getElementById("books");
  box.innerHTML = "";
  const snap = await db.collection("books").get();
  snap.forEach(doc => {
    const b = doc.data();
    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${doc.id}', ${b.price})">
          Buy with Pi
        </button>
      </div>`;
  });
}

function toggleAdd(){
  addBook.classList.toggle("hidden");
}

/* ================= UPLOAD ================= */
async function uploadBook(){
  if(!rights.checked) return alert("Confirm ownership");
  const titleVal = title.value.trim();
  const priceVal = Number(price.value);
  if(!titleVal || !priceVal || !cover.files[0] || !pdf.files[0])
    return alert("Fill all fields");
  uploadBtn.disabled = true;
  try {
    const coverURL = await uploadCloudinary(cover.files[0], "covers");
    const pdfURL = await uploadCloudinary(pdf.files[0], "pdfs");
    await db.collection("books").add({
      title: titleVal,
      price: priceVal,
      cover: coverURL,
      pdf: pdfURL,
      owner: user.username,
      createdAt: Date.now()
    });
    alert("Book uploaded successfully!");
    addBook.classList.add("hidden");
    loadBooks();
  } catch(e){
    console.error(e);
    alert("Upload failed: " + e.message);
  }
  uploadBtn.disabled = false;
}

/* ================= Ø¥ÙƒÙ…Ø§Ù„ Ø¯ÙØ¹Ø© Ù…Ø¹Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ================= */
async function onIncompletePaymentFound(incompletePayment) {
  alert("ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¯ÙØ¹Ø© Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹Ù„Ù‚Ø©... Ø¬Ø§Ø±ÙŠ Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
  console.log("Incomplete payment found:", incompletePayment);

  // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù…Ø¹ txid Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ incompletePayment
  try {
    const response = await fetch("https://pi-backend-c8nz.onrender.com/complete-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        paymentId: incompletePayment.identifier,
        txid: incompletePayment.transaction?.txid  // txid Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¯ÙØ¹
      })
    });

    if (!response.ok) {
      const err = await response.json();
      console.error("Failed to complete incomplete payment:", err);
      alert("ÙØ´Ù„ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ developers.minepi.com Ù„Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.");
      return;
    }

    alert("ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¬Ø±Ø§Ø¡ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯.");
  } catch (err) {
    console.error("Error completing incomplete payment:", err);
    alert("Ø®Ø·Ø£ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©. Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø£ÙƒÙ…Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….");
  }
}

/* ================= BUY - FINAL FIXED ================= */
async function buy(bookId, price){
  if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù‚Ø§Ø¨Ù„ ${price} PiØŸ`)) return;

  try {
    await Pi.createPayment(
      {
        amount: price,
        currency: "Pi",
        memo: "Ø´Ø±Ø§Ø¡ ÙƒØªØ§Ø¨ Ù…Ù† Spicy Library",
        metadata: { bookId }
      },
      {
        onReadyForServerApproval: async (paymentId) => {
          console.log("Approving payment:", paymentId);
          try {
            const res = await fetch("https://pi-backend-c8nz.onrender.com/approve-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            if (!res.ok) throw new Error(await res.text());
          } catch (err) {
            console.error("Approve failed:", err);
          }
        },

        onReadyForServerCompletion: async (paymentId, txid) => {
          console.log("Completing payment:", paymentId, "txid:", txid);
          try {
            const response = await fetch("https://pi-backend-c8nz.onrender.com/complete-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Completion failed:", errorData);
              alert("ÙØ´Ù„ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹!\nØ§Ù„ØªÙØ§ØµÙŠÙ„: " + JSON.stringify(errorData));
              return;
            }

            const doc = await db.collection("books").doc(bookId).get();
            if (!doc.exists) {
              alert("Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
              return;
            }
            const pdfUrl = doc.data().pdf;
            window.open(pdfUrl, "_blank");
            alert("ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ÙƒØªØ§Ø¨ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù† ğŸ“š");

          } catch (err) {
            console.error("Completion error:", err);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø«Ù†Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹.");
          }
        },

        onCancel: () => alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"),

        onError: (error, payment) => {
          console.error("Pi Payment Error:", error, payment);
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " + error.message + "\nØ¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¯ÙØ¹Ø© Ù…Ø¹Ù„Ù‚Ø©ØŒ Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.");
        }
      }
    );
  } catch (e) {
    console.error("Payment initiation failed:", e);
    alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Pi Browser.");
  }
}
</script>
</body>
</html>
