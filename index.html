<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸŒ¶ï¸ Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:20px; margin:0; }
button { padding:10px 20px; border:none; border-radius:6px; background:#ff4500; color:#fff; cursor:pointer; margin:5px; }
button:disabled { background:#555; cursor:not-allowed; }
input { padding:8px; margin:5px; width:90%; }
.hidden { display:none; }
.books { display:flex; flex-wrap:wrap; justify-content:center; }
.book { background:#1c1c1c; border:1px solid #333; border-radius:8px; padding:15px; margin:10px; width:220px; }
.book img { width:200px; }
.notice { font-size:14px; color:#ccc; }
</style>
</head>
<body>

<div id="login">
  <h1>ğŸŒ¶ï¸ Spicy Library</h1>
  <p class="notice">Login using Pi Network</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">â• Add Book</button>
  <button onclick="logout()">Logout</button>

  <div id="addBook" class="hidden">
    <h3>Add Book</h3>
    <input id="title" placeholder="Book title">
    <input id="price" type="number" placeholder="Price (Pi)">
    <p>ğŸ“· Book Cover</p>
    <input type="file" id="cover" accept="image/*">
    <p>ğŸ“„ Book File (PDF)</p>
    <input type="file" id="pdf" accept="application/pdf"><br><br>
    <label class="notice">
      <input type="checkbox" id="rights"> I confirm that I fully own the rights
    </label><br><br>
    <button id="uploadBtn" onclick="uploadBook()">Upload Book</button>
  </div>

  <h3>Books</h3>
  <div class="books" id="books"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwYuJrfAYQ1kTp78ggUKFtQx192i2VsQM",
  authDomain: "spicy-97f54.firebaseapp.com",
  projectId: "spicy-97f54"
});
const db = firebase.firestore();

/* ================= PI ================= */
Pi.init({ version: "2.0", sandbox: false }); // Mainnet
let user = null;

/* ================= CLOUDINARY ================= */
const CLOUD_NAME = "dkb0phegf";
const UPLOAD_PRESET = "spicy1998";
async function uploadCloudinary(file, folder) {
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET);
  fd.append("folder", folder);
  const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method:"POST", body:fd });
  const d = await r.json();
  return d.secure_url;
}

/* ================= LOGIN ================= */
loginBtn.onclick = async () => {
  try {
    const auth = await Pi.authenticate(["username","payments"]);
    user = auth.user;
    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "Welcome " + user.username;
    loadBooks();
  } catch(e) {
    alert("Login failed. Please use Pi Browser and ensure your app is registered.");
  }
};

function logout() { location.reload(); }

/* ================= BOOKS ================= */
async function loadBooks() {
  const box = document.getElementById("books");
  box.innerHTML = "";
  const snap = await db.collection("books").get();
  snap.forEach(doc => {
    const b = doc.data();
    box.innerHTML += `
      <div class="book">
        <img src="${b.cover}">
        <h4>${b.title}</h4>
        <p>${b.price} Pi</p>
        <button onclick="buy('${doc.id}', ${b.price}, '${b.title}')">Buy with Pi</button>
      </div>`;
  });
}

function toggleAdd() { addBook.classList.toggle("hidden"); }

/* ================= UPLOAD ================= */
async function uploadBook() {
  if(!rights.checked){ alert("You must confirm book ownership"); return; }
  const titleVal = title.value.trim();
  const priceVal = Number(price.value);
  const coverFile = cover.files[0];
  const pdfFile = pdf.files[0];
  if(!titleVal || !priceVal || !coverFile || !pdfFile){ alert("Please fill all fields"); return; }

  uploadBtn.disabled = true;
  uploadBtn.innerText = "Uploading...";
  try {
    const coverURL = await uploadCloudinary(coverFile,"covers");
    const pdfURL = await uploadCloudinary(pdfFile,"pdfs");
    await db.collection("books").add({
      title: titleVal,
      price: priceVal,
      cover: coverURL,
      pdf: pdfURL,
      owner: user.username,
      createdAt: Date.now()
    });
    alert("âœ… Book uploaded successfully");
    addBook.classList.add("hidden");
    loadBooks();
  } catch(e) {
    console.error(e);
    alert("Upload failed. Check console.");
  }
  uploadBtn.disabled = false;
  uploadBtn.innerText = "Upload Book";
}

/* ================= BUY ================= */
function buy(bookId, price, title) {
  if (!confirm(`Buy "${title}" for ${price} Pi?`)) return;

  // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
  Pi.createPayment(
    {
      amount: Number(price),   // Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ù€ Pi
      currency: "Pi",          // Ø§Ù„Ø¹Ù…Ù„Ø©
      memo: `Purchase "${title}" from Spicy Library`, // ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      metadata: { bookId, title, price } // Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ØªØ­ØªØ§Ø¬Ù‡Ø§ Ø§Ù„Ù…Ø­ÙØ¸Ø©
    },
    {
      onReadyForServerApproval: function(paymentId) {
        console.log("Payment ID (send to backend if needed):", paymentId);
      },
      onReadyForServerCompletion: async function(paymentId, txid) {
        alert(`Payment successful! TXID: ${txid}`);
        const doc = await db.collection("books").doc(bookId).get();
        window.open(doc.data().pdf, "_blank");
      },
      onCancel: function() { alert("Payment cancelled by user"); },
      onError: function(err) {
        console.error("Payment error:", err);
        alert("Payment error: " + (err.message || "Unknown error"));
      }
    }
  );
}
</script>

</body>
</html>
